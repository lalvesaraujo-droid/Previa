<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Prévia</title>

<link rel="stylesheet" href="styles.css">

<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

<style>
body{
font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto;
margin:0;
background:linear-gradient(180deg,#0f2a44,#143a5a);
color:white;
}

.container{padding:20px}

.card{
background:rgba(255,255,255,.08);
border-radius:18px;
padding:18px;
margin-top:16px;
backdrop-filter:blur(10px);
}

input,textarea,select{
width:100%;
padding:12px;
border-radius:10px;
border:none;
margin-top:6px;
margin-bottom:14px;
}

button{
padding:12px 16px;
border:none;
border-radius:12px;
font-weight:600;
}

.primary{background:#3b82f6;color:white}
.secondary{background:rgba(255,255,255,.2);color:white}
.danger{background:#ef4444;color:white}

.hidden{display:none}

.historyItem{
background:rgba(255,255,255,.08);
border-radius:12px;
padding:12px;
margin-bottom:12px;
}
</style>
</head>

<body>

<div class="container">

<h1>Prévia</h1>
<div style="opacity:.8;margin-bottom:10px">
Dr Leonardo Alves Araújo • CRM-MG 47310 • RQE 40542
</div>

<!-- HOME -->
<div id="home" class="card">
<h2>Home</h2>
<button class="primary" onclick="nova()">Nova avaliação</button>
<button class="secondary" onclick="verHistorico()">Histórico</button>
</div>

<!-- FORM -->
<div id="form" class="card hidden">

<h2>Nova avaliação</h2>

<label>Paciente</label>
<input id="paciente">

<label>Idade</label>
<input id="idade">

<label>ASA</label>
<select id="asa">
<option>I</option>
<option>II</option>
<option>III</option>
<option>IV</option>
</select>

<label>Procedimento</label>
<input id="procedimento">

<label>Comorbidades</label>
<textarea id="comorb"></textarea>

<label>Medicações</label>
<textarea id="medic"></textarea>

<label>Via aérea (Mallampati)</label>
<select id="mall">
<option>I</option>
<option>II</option>
<option>III</option>
<option>IV</option>
</select>

<label>Estratégia anestésica</label>
<textarea id="estrat"></textarea>

<label>Condição</label>
<input id="cond">

<label>Conduta</label>
<textarea id="conduta"></textarea>

<label>Foto</label>
<input type="file" id="foto">

<button class="primary" onclick="salvar()">Salvar</button>
<button class="secondary" onclick="home()">Voltar</button>

</div>

<!-- HISTORICO -->
<div id="hist" class="card hidden">
<h2>Histórico</h2>
<div id="lista"></div>

<button class="secondary" onclick="home()">Home</button>
<button class="danger" onclick="localStorage.clear();verHistorico()">Apagar tudo</button>
</div>

<!-- RESUMO -->
<div id="resumo" class="card hidden">
<h2>Resumo</h2>
<div id="resumoTxt"></div>

<button class="primary" onclick="gerarPDF()">Gerar PDF</button>
<button class="secondary" onclick="verHistorico()">Voltar</button>
</div>

</div>

<script>

let atual=null

function home(){
hideAll()
document.getElementById("home").classList.remove("hidden")
}

function nova(){
hideAll()
document.getElementById("form").classList.remove("hidden")
}

function verHistorico(){
hideAll()
document.getElementById("hist").classList.remove("hidden")

let dados=JSON.parse(localStorage.getItem("previas")||"[]")
let html=""

dados.forEach((d,i)=>{
html+=`
<div class="historyItem">
<b>${d.paciente||"Sem nome"}</b><br>
${d.procedimento||""}<br>
ASA ${d.asa} • Mallampati ${d.mall}<br><br>
<button onclick="abrir(${i})">Ver resumo</button>
</div>`
})

document.getElementById("lista").innerHTML=html
}

function abrir(i){
let dados=JSON.parse(localStorage.getItem("previas")||"[]")
atual=dados[i]

hideAll()
document.getElementById("resumo").classList.remove("hidden")

document.getElementById("resumoTxt").innerHTML=`
<b>${atual.paciente}</b><br>
${atual.procedimento}<br>
ASA ${atual.asa} • Mallampati ${atual.mall}<br><br>
${atual.estrat}
`
}

function salvar(){

let reader=new FileReader()

let file=document.getElementById("foto").files[0]

if(file){
reader.onload=function(){
gravar(reader.result)
}
reader.readAsDataURL(file)
}else{
gravar(null)
}

}

function gravar(fotoData){

let obj={
paciente:paciente.value,
idade:idade.value,
asa:asa.value,
procedimento:procedimento.value,
comorb:comorb.value,
medic:medic.value,
mall:mall.value,
estrat:estrat.value,
cond:cond.value,
conduta:conduta.value,
foto:fotoData
}

let dados=JSON.parse(localStorage.getItem("previas")||"[]")
dados.unshift(obj)
localStorage.setItem("previas",JSON.stringify(dados))

home()
}

function gerarPDF(){

const { jsPDF } = window.jspdf
let doc=new jsPDF()

// CAPA
doc.setFontSize(22)
doc.text("Prévia",20,20)

doc.setFontSize(10)
doc.text("Dr Leonardo Alves Araújo",20,28)
doc.text("CRM-MG 47310 • RQE 40542",20,33)

doc.setFontSize(16)
doc.text(atual.paciente||"",20,50)

doc.setFontSize(12)
doc.text("Procedimento:",20,65)
doc.text(atual.procedimento||"",20,72)

doc.text("ASA "+atual.asa+" • Mallampati "+atual.mall,20,85)

if(atual.foto){
doc.addImage(atual.foto,"JPEG",140,40,50,50)
}

// PAG 2
doc.addPage()

doc.setFontSize(16)
doc.text("Estratégia anestésica",20,20)

doc.setFontSize(12)
doc.text(doc.splitTextToSize(atual.estrat||"",170),20,35)

doc.save("previa.pdf")
}

function hideAll(){
document.getElementById("home").classList.add("hidden")
document.getElementById("form").classList.add("hidden")
document.getElementById("hist").classList.add("hidden")
document.getElementById("resumo").classList.add("hidden")
}

</script>

</body>
</html>