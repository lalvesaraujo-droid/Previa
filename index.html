<!doctype html>
<html lang="pt-br">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>Pr√©via</title>
  <style>
    :root{
      --bg1:#0b2236;
      --bg2:#0f3854;
      --card: rgba(255,255,255,.10);
      --card2: rgba(255,255,255,.14);
      --txt: rgba(255,255,255,.92);
      --muted: rgba(255,255,255,.72);
      --stroke: rgba(255,255,255,.18);
      --primary:#2b86ff;
      --danger:#e04949;
      --shadow: 0 18px 50px rgba(0,0,0,.35);
      --radius: 22px;
      --font: -apple-system, BlinkMacSystemFont, "SF Pro Display","SF Pro Text", Segoe UI, Roboto, Helvetica, Arial, sans-serif;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family:var(--font);
      color:var(--txt);
      background:
        radial-gradient(1200px 800px at 20% 10%, rgba(53,144,255,.25), transparent 55%),
        radial-gradient(900px 600px at 80% 80%, rgba(52,211,153,.12), transparent 60%),
        linear-gradient(180deg,var(--bg2),var(--bg1));
      padding: env(safe-area-inset-top) 18px env(safe-area-inset-bottom) 18px;
    }
    .wrap{max-width:760px;margin:0 auto;padding:22px 0 36px}
    .topbar{display:flex;align-items:flex-start;justify-content:space-between;gap:14px;margin-bottom:14px}
    .brand{display:flex;align-items:center;gap:10px}
    .mark{width:12px;height:12px;border-radius:6px;background:var(--primary);box-shadow:0 0 0 6px rgba(43,134,255,.15);margin-top:8px}
    .brand h1{margin:0;font-weight:800;letter-spacing:.2px;font-size:44px;line-height:1}
    .docline{font-size:14px;line-height:1.3;color:var(--muted);margin-top:8px}
    .pill{display:inline-flex;align-items:center;gap:10px;padding:10px 14px;border-radius:999px;background:rgba(255,255,255,.08);border:1px solid rgba(255,255,255,.12);color:rgba(255,255,255,.85);font-size:13px;white-space:nowrap;margin-top:10px}
    .card{background:linear-gradient(180deg,var(--card2),var(--card));border:1px solid var(--stroke);border-radius:var(--radius);box-shadow:var(--shadow);padding:18px;backdrop-filter: blur(12px);-webkit-backdrop-filter: blur(12px)}
    .card + .card{margin-top:14px}
    .title{margin:0 0 6px 0;font-size:40px;letter-spacing:-.4px}
    .subtitle{margin:0 0 16px 0;color:var(--muted);font-size:16px;line-height:1.35}
    .row{display:flex;gap:12px;flex-wrap:wrap}
    .btn{appearance:none;border:1px solid rgba(255,255,255,.16);background:rgba(255,255,255,.10);color:rgba(255,255,255,.92);border-radius:18px;padding:14px 16px;font-size:18px;font-weight:700;cursor:pointer;min-width:160px;flex:1;transition:.15s transform ease}
    .btn:active{transform:scale(.99)}
    .btn.primary{background:rgba(43,134,255,.95);border-color:rgba(43,134,255,.65)}
    .btn.ghost{background:rgba(255,255,255,.08)}
    .btn.danger{background:rgba(224,73,73,.92);border-color:rgba(224,73,73,.65)}
    .btn.small{min-width:auto;flex:0;padding:10px 12px;font-size:16px;border-radius:14px}
    .btn:disabled{opacity:.45;cursor:not-allowed}
    .progress{display:flex;align-items:center;justify-content:space-between;gap:10px;margin:0 0 12px 0}
    .steps{display:flex;gap:6px;flex-wrap:wrap}
    .dot{width:10px;height:10px;border-radius:999px;background:rgba(255,255,255,.22);border:1px solid rgba(255,255,255,.22)}
    .dot.on{background:rgba(43,134,255,.95);border-color:rgba(43,134,255,.75)}
    .stepName{color:var(--muted);font-weight:700;font-size:14px}
    .stepTitle{margin:0 0 10px 0;font-size:26px}
    label{display:block;margin:12px 0 6px 2px;color:rgba(255,255,255,.88);font-weight:700}
    input,select,textarea{width:100%;background:rgba(255,255,255,.90);border:1px solid rgba(0,0,0,.06);border-radius:18px;padding:14px 14px;font-size:18px;outline:none}
    textarea{min-height:110px;resize:vertical}
    .hint{margin:8px 2px 0;color:var(--muted);font-size:13px;line-height:1.35}
    .divider{height:1px;background:rgba(255,255,255,.12);margin:14px 0}
    .historyList{display:flex;flex-direction:column;gap:12px}
    .item{background:rgba(255,255,255,.08);border:1px solid rgba(255,255,255,.14);border-radius:18px;padding:14px}
    .itemTop{display:flex;align-items:flex-start;justify-content:space-between;gap:10px}
    .item h3{margin:0;font-size:18px}
    .item p{margin:6px 0 0;color:var(--muted);line-height:1.35}
    .tag{display:inline-flex;align-items:center;gap:8px;font-size:12px;font-weight:800;color:rgba(255,255,255,.9);background:rgba(255,255,255,.10);border:1px solid rgba(255,255,255,.15);padding:7px 10px;border-radius:999px;white-space:nowrap}
    .toast{position:fixed;left:50%;bottom:18px;transform:translateX(-50%);background:rgba(0,0,0,.55);color:#fff;padding:12px 14px;border-radius:999px;border:1px solid rgba(255,255,255,.14);font-weight:800;display:none;z-index:9999;max-width:92vw;text-align:center}
    .hidden{display:none}
  </style>
</head>

<body>
  <div class="wrap">
    <div class="topbar">
      <div>
        <div class="brand">
          <div class="mark"></div>
          <h1>Pr√©via</h1>
        </div>
        <div class="docline" id="docLine">
          Dr Leonardo Alves Ara√∫jo ‚Ä¢ CRM-MG 47310 ‚Ä¢ RQE 40542
        </div>
      </div>
      <div class="pill" id="pillInfo">
        Hist√≥rico ‚Ä¢ Vis√£o r√°pida ‚Ä¢ PDF premium
      </div>
    </div>

    <section class="card" id="screenHome">
      <h2 class="title">Home</h2>
      <p class="subtitle">Fazer avalia√ß√£o em <b>8 etapas</b>, salvar no aparelho e gerar PDF com cara de hospital grande.</p>
      <div class="row">
        <button class="btn primary" onclick="startNew()">Nova avalia√ß√£o</button>
        <button class="btn ghost" onclick="openHistory()">Hist√≥rico</button>
      </div>
      <p class="hint" style="margin-top:12px">
        Se abrir s√≥ <b>...github.io</b> pode dar 404. Em projeto, use <b>/Previa/</b>.
      </p>
    </section>

    <section class="card hidden" id="screenWizard">
      <div class="progress">
        <div class="steps" id="dots"></div>
        <div class="stepName" id="stepName">Etapa</div>
      </div>

      <h3 class="stepTitle" id="stepTitle">Etapa</h3>
      <div id="stepBody"></div>

      <div class="divider"></div>

      <div class="row">
        <button class="btn ghost" id="btnBack" onclick="prevStep()">Voltar</button>
        <button class="btn primary" id="btnNext" onclick="nextStep()">Pr√≥ximo</button>
      </div>
      <p class="hint" id="wizardHint"></p>
    </section>

    <section class="card hidden" id="screenSummary">
      <h2 class="title">Resumo</h2>
      <p class="subtitle">Uma vis√£o r√°pida pro anestesista (e base do PDF premium).</p>

      <div class="card" style="box-shadow:none;background:rgba(255,255,255,.08);border-radius:18px" id="summaryBox"></div>

      <div class="divider"></div>

      <div class="row">
        <button class="btn ghost" onclick="copyResumo()">Copiar resumo</button>
        <button class="btn primary" onclick="openPdf()">Gerar PDF premium</button>
      </div>

      <div class="row" style="margin-top:10px">
        <button class="btn ghost" onclick="openHistory()">Ir para hist√≥rico</button>
        <button class="btn ghost" onclick="goHome()">Home</button>
      </div>

      <p class="hint">O PDF abre em outra aba. Depois: ‚ÄúCompartilhar ‚Üí Imprimir ‚Üí Salvar em PDF‚Äù.</p>
    </section>

    <section class="card hidden" id="screenHistory">
      <h2 class="title">Hist√≥rico</h2>
      <p class="subtitle">Fica salvo no aparelho (localStorage). Se limpar dados do Safari, some.</p>
      <div class="historyList" id="historyList"></div>

      <div class="divider"></div>
      <div class="row">
        <button class="btn ghost" onclick="goHome()">Home</button>
        <button class="btn danger" onclick="clearHistory()">Apagar tudo</button>
      </div>
    </section>
  </div>

  <div class="toast" id="toast">Ok</div>

<script>
// =====================
// Config / Estado
// =====================
const STORAGE_KEY = "previa_avaliacoes_v2";

const steps = [
  { t:"Identifica√ß√£o", render: renderIdentificacao, validate: validateIdentificacao },
  { t:"Procedimento",   render: renderProcedimento,   validate: ()=>true },
  { t:"Hist√≥rico",      render: renderHistorico,      validate: ()=>true },
  { t:"Cl√≠nico",        render: renderClinico,        validate: ()=>true },
  { t:"Alto impacto",   render: renderAltoImpacto,    validate: ()=>true },
  { t:"Via a√©rea",      render: renderViaAerea,       validate: ()=>true },
  { t:"Estrat√©gia",     render: renderEstrategia,     validate: ()=>true },
  { t:"Conduta + Foto", render: renderCondutaFoto,    validate: ()=>true },
];

let currentStep = 0;
let draft = {
  // identifica√ß√£o
  paciente:"", idade:"", asa:"I",
  // procedimento
  procedimento:"",
  // hist√≥rico
  passado_cirurgico:"",
  intercorrencias:"",
  // cl√≠nico
  alergias:"",
  comorbidades:"",
  medicacoes:"",
  jejum:"",
  // alto impacto
  glp1:"",
  anticoag:"",
  // via a√©rea
  mallampati:"I",
  via_aerea_obs:"",
  // estrat√©gia
  estrategia:"",
  // conduta/final
  condicao:"",
  conduta:"",
  consentimento:"Consentimento informado obtido.",
  // foto (base64)
  fotoData:"",
  fotoName:""
};

// =====================
// Util
// =====================
function $(id){ return document.getElementById(id); }

function toast(msg){
  const el = $("toast");
  el.textContent = msg;
  el.style.display = "block";
  clearTimeout(toast._t);
  toast._t = setTimeout(()=> el.style.display="none", 1600);
}

function escapeHtml(s){
  return (s||"").toString()
    .replaceAll("&","&amp;")
    .replaceAll("<","&lt;")
    .replaceAll(">","&gt;")
    .replaceAll('"',"&quot;")
    .replaceAll("'","&#039;");
}

function showScreen(name){
  ["screenHome","screenWizard","screenSummary","screenHistory"].forEach(id=>{
    $(id).classList.add("hidden");
  });
  $(name).classList.remove("hidden");
  window.scrollTo({top:0,behavior:"smooth"});
}

// =====================
// Navega√ß√£o
// =====================
function goHome(){ showScreen("screenHome"); }

function startNew(){
  // zera rascunho
  currentStep = 0;
  draft = {
    paciente:"", idade:"", asa:"I",
    procedimento:"",
    passado_cirurgico:"",
    intercorrencias:"",
    alergias:"",
    comorbidades:"",
    medicacoes:"",
    jejum:"",
    glp1:"",
    anticoag:"",
    mallampati:"I",
    via_aerea_obs:"",
    estrategia:"",
    condicao:"",
    conduta:"",
    consentimento:"Consentimento informado obtido.",
    fotoData:"",
    fotoName:""
  };
  showScreen("screenWizard");
  updateStepUI();
}

function prevStep(){
  if(currentStep<=0){ goHome(); return; }
  currentStep--;
  updateStepUI();
}

function nextStep(){
  // coleta valores do step atual antes de validar
  collectCurrentStep();

  const ok = steps[currentStep].validate ? steps[currentStep].validate() : true;
  if(!ok) return;

  if(currentStep < steps.length-1){
    currentStep++;
    updateStepUI();
  }else{
    openSummary();
  }
}

function updateDots(){
  const dots = $("dots");
  dots.innerHTML = "";
  steps.forEach((_,i)=>{
    const d=document.createElement("div");
    d.className = "dot" + (i===currentStep ? " on":"");
    dots.appendChild(d);
  });
}

function updateStepUI(){
  updateDots();
  $("stepName").textContent = `Etapa ${currentStep+1} de ${steps.length}`;
  $("stepTitle").textContent = steps[currentStep].t;
  $("stepBody").innerHTML = "";
  steps[currentStep].render($("stepBody"));

  $("btnBack").textContent = currentStep===0 ? "Home" : "Voltar";
  $("btnNext").textContent = currentStep===steps.length-1 ? "Finalizar" : "Pr√≥ximo";
  $("wizardHint").textContent =
    currentStep===steps.length-1
      ? "No final, voc√™ salva e gera o resumo/PDF."
      : "Preencha o essencial e siga. Consulta r√°pida, sem novela. üôÇ";
}

// =====================
// Render de etapas
// =====================
function renderIdentificacao(root){
  root.innerHTML = `
    <label>Paciente</label>
    <input id="f_paciente" placeholder="Nome completo" value="${escapeHtml(draft.paciente)}" />

    <label>Idade</label>
    <input id="f_idade" placeholder="Ex: 32" value="${escapeHtml(draft.idade)}" inputmode="numeric" />

    <label>ASA</label>
    <select id="f_asa">
      ${["I","II","III","IV"].map(v=>`<option ${draft.asa===v?"selected":""}>${v}</option>`).join("")}
    </select>

    <p class="hint">Esses 3 campos alimentam hist√≥rico, resumo e PDF.</p>
  `;
}

function validateIdentificacao(){
  const p = ($("f_paciente").value||"").trim();
  const i = ($("f_idade").value||"").trim();
  if(!p){
    toast("Preencha o nome do paciente.");
    return false;
  }
  if(i && !/^\d{1,3}$/.test(i)){
    toast("Idade: use s√≥ n√∫meros.");
    return false;
  }
  return true;
}

function renderProcedimento(root){
  root.innerHTML = `
    <label>Procedimento</label>
    <input id="f_proc" placeholder="Ex: Mamoplastia redutora" value="${escapeHtml(draft.procedimento)}" />

    <p class="hint">Dica: se quiser, adicione lateralidade/tempo previsto.</p>
  `;
}

function renderHistorico(root){
  root.innerHTML = `
    <label>Passado cir√∫rgico</label>
    <input id="f_passado" placeholder="Ex: Colecistectomia (2019), Ces√°rea (2014)" value="${escapeHtml(draft.passado_cirurgico)}" />

    <label>Intercorr√™ncias anest√©sicas anteriores</label>
    <input id="f_inter" placeholder="Ex: PONV; intuba√ß√£o dif√≠cil; nenhuma" value="${escapeHtml(draft.intercorrencias)}" />
  `;
}

function renderClinico(root){
  root.innerHTML = `
    <label>Alergias</label>
    <input id="f_alergias" placeholder="Ex: Dipirona (urtic√°ria) / Nenhuma" value="${escapeHtml(draft.alergias)}" />

    <label>Comorbidades</label>
    <input id="f_comorb" placeholder="Ex: HAS / DM / Asma / Nenhuma" value="${escapeHtml(draft.comorbidades)}" />

    <label>Medica√ß√µes em uso</label>
    <textarea id="f_meds" placeholder="Ex: Losartana 50mg; Metformina">${escapeHtml(draft.medicacoes)}</textarea>

    <label>Jejum (horas)</label>
    <input id="f_jejum" placeholder="Ex: 8" value="${escapeHtml(draft.jejum)}" />
  `;
}

function renderAltoImpacto(root){
  root.innerHTML = `
    <label>GLP-1 (Ozempic / an√°logos)</label>
    <input id="f_glp1" placeholder="Ex: semanal; √∫ltima dose 10/02" value="${escapeHtml(draft.glp1)}" />

    <label>Anticoagulante / antiagregante</label>
    <input id="f_anticoag" placeholder="Ex: Rivaroxabana; √∫ltima dose ontem 20h" value="${escapeHtml(draft.anticoag)}" />

    <p class="hint">Se n√£o usa, pode deixar em branco.</p>
  `;
}

function renderViaAerea(root){
  root.innerHTML = `
    <label>Via a√©rea (Mallampati)</label>
    <select id="f_mall">
      ${["I","II","III","IV"].map(v=>`<option ${draft.mallampati===v?"selected":""}>${v}</option>`).join("")}
    </select>

    <label>Observa√ß√£o (opcional)</label>
    <input id="f_va_obs" placeholder="Ex: MM 2/3 (vide foto); sem VAD" value="${escapeHtml(draft.via_aerea_obs)}" />
  `;
}

function renderEstrategia(root){
  root.innerHTML = `
    <label>Estrat√©gia anest√©sica</label>
    <textarea id="f_estrat" placeholder="Ex: Geral + analgesia sist√™mica; profilaxia PONV; analgesia multimodal...">${escapeHtml(draft.estrategia)}</textarea>

    <p class="hint">Isso vira um bloco grande no PDF (2¬™ p√°gina tamb√©m).</p>
  `;
}

function renderCondutaFoto(root){
  root.innerHTML = `
    <label>Condi√ß√£o</label>
    <input id="f_condicao" placeholder="Apto / Pend√™ncia" value="${escapeHtml(draft.condicao)}" />

    <label>Conduta</label>
    <textarea id="f_conduta" placeholder="Jejum, orienta√ß√µes, ajustes de medica√ß√£o, chegada ao hospital...">${escapeHtml(draft.conduta)}</textarea>

    <label>Texto curto (consentimento)</label>
    <input id="f_consent" value="${escapeHtml(draft.consentimento)}" />

    <label>Foto do paciente (capa do PDF)</label>
    <input type="file" id="f_foto" accept="image/*" />

    <p class="hint">A foto √© salva no aparelho (base64) junto do hist√≥rico.</p>
  `;

  // listener de foto
  const inp = $("f_foto");
  inp.addEventListener("change", async (e)=>{
    const file = e.target.files && e.target.files[0];
    if(!file) return;
    draft.fotoName = file.name || "foto";
    draft.fotoData = await fileToDataUrl(file);
    toast("Foto carregada ‚úÖ");
  });
}

function fileToDataUrl(file){
  return new Promise((resolve,reject)=>{
    const r = new FileReader();
    r.onload = ()=>resolve(r.result);
    r.onerror = reject;
    r.readAsDataURL(file);
  });
}

// =====================
// Coleta do step atual
// =====================
function collectCurrentStep(){
  switch(currentStep){
    case 0:
      draft.paciente = ($("f_paciente").value||"").trim();
      draft.idade = ($("f_idade").value||"").trim();
      draft.asa = ($("f_asa").value||"I").trim();
      break;
    case 1:
      draft.procedimento = ($("f_proc").value||"").trim();
      break;
    case 2:
      draft.passado_cirurgico = ($("f_passado").value||"").trim();
      draft.intercorrencias = ($("f_inter").value||"").trim();
      break;
    case 3:
      draft.alergias = ($("f_alergias").value||"").trim();
      draft.comorbidades = ($("f_comorb").value||"").trim();
      draft.medicacoes = ($("f_meds").value||"").trim();
      draft.jejum = ($("f_jejum").value||"").trim();
      break;
    case 4:
      draft.glp1 = ($("f_glp1").value||"").trim();
      draft.anticoag = ($("f_anticoag").value||"").trim();
      break;
    case 5:
      draft.mallampati = ($("f_mall").value||"I").trim();
      draft.via_aerea_obs = ($("f_va_obs").value||"").trim();
      break;
    case 6:
      draft.estrategia = ($("f_estrat").value||"").trim();
      break;
    case 7:
      draft.condicao = ($("f_condicao").value||"").trim();
      draft.conduta = ($("f_conduta").value||"").trim();
      draft.consentimento = ($("f_consent").value||"").trim();
      // foto j√° √© coletada no listener
      break;
  }// =====================
// Resumo / Hist√≥rico / PDF
// =====================

function short(s){ return (s||"").trim(); }

function buildResumo(){
  const idadeTxt = short(draft.idade) ? `${draft.idade} anos` : "";
  const asaTxt = short(draft.asa) ? `ASA ${draft.asa}` : "";
  const head = `${short(draft.paciente) || "Paciente"}${idadeTxt?`, ${idadeTxt}`:""}${asaTxt?`, ${asaTxt}`:""}.`;

  const lines = [];
  if(short(draft.procedimento)) lines.push(`Procedimento: ${draft.procedimento}.`);
  if(short(draft.comorbidades)) lines.push(`Comorbidades: ${draft.comorbidades}.`);
  if(short(draft.medicacoes)) lines.push(`Medica√ß√µes: ${draft.medicacoes}.`);
  lines.push(`Via a√©rea: Mallampati ${draft.mallampati}${short(draft.via_aerea_obs)?` (${draft.via_aerea_obs})`:""}.`);
  if(short(draft.estrategia)) lines.push(`Estrat√©gia: ${draft.estrategia}.`);
  if(short(draft.condicao)) lines.push(`Condi√ß√£o: ${draft.condicao}.`);
  if(short(draft.conduta)) lines.push(`Conduta: ${draft.conduta}.`);

  // ‚Äúalto impacto‚Äù
  const impacto = [];
  if(short(draft.glp1)) impacto.push(`GLP-1: ${draft.glp1}`);
  if(short(draft.anticoag)) impacto.push(`Antico/antiagregante: ${draft.anticoag}`);
  if(impacto.length) lines.push(`Medicamentos de alto impacto: ${impacto.join(" | ")}.`);

  // hist√≥rico
  const hist = [];
  if(short(draft.passado_cirurgico)) hist.push(`Passado cir√∫rgico: ${draft.passado_cirurgico}`);
  if(short(draft.intercorrencias)) hist.push(`Intercorr√™ncias anest√©sicas: ${draft.intercorrencias}`);
  if(hist.length) lines.push(hist.join(". ") + ".");

  // cl√≠nico extra
  const clin = [];
  if(short(draft.alergias)) clin.push(`Alergias: ${draft.alergias}`);
  if(short(draft.jejum)) clin.push(`Jejum: ${draft.jejum}h`);
  if(clin.length) lines.push(clin.join(". ") + ".");

  // consentimento
  if(short(draft.consentimento)) lines.push(draft.consentimento);

  return `${head}\n\n${lines.join("\n")}`.trim();
}

function openSummary(){
  const resumo = buildResumo();
  $("summaryText").value = resumo;
  showScreen("screenSummary");
}

// Copiar resumo (para colar em WhatsApp/Prontu√°rio)
function copyResumo(){
  const t = $("summaryText").value || "";
  navigator.clipboard?.writeText(t).then(()=>toast("Copiado ‚úÖ")).catch(()=>{
    // fallback
    $("summaryText").select();
    document.execCommand("copy");
    toast("Copiado ‚úÖ");
  });
}

// =====================
// Salvar / Hist√≥rico
// =====================
function readAll(){
  try{
    return JSON.parse(localStorage.getItem(STORAGE_KEY) || "[]") || [];
  }catch(e){
    return [];
  }
}

function writeAll(list){
  localStorage.setItem(STORAGE_KEY, JSON.stringify(list));
}

function saveCurrent(){
  // garante que √∫ltimo step foi coletado
  collectCurrentStep();

  const list = readAll();
  const now = new Date();
  const id = `${now.getTime()}`;

  const item = {
    id,
    createdAt: now.toISOString(),
    paciente: short(draft.paciente) || "Sem nome",
    idade: short(draft.idade) || "",
    asa: short(draft.asa) || "I",
    procedimento: short(draft.procedimento) || "Procedimento n√£o informado",
    mallampati: short(draft.mallampati) || "I",
    resumo: buildResumo(),
    data: { ...draft } // snapshot completo
  };

  // coloca no topo
  list.unshift(item);
  writeAll(list);

  toast("Salvo no hist√≥rico ‚úÖ");
  openHistory();
}

function openHistory(){
  renderHistory();
  showScreen("screenHistory");
}

function renderHistory(){
  const list = readAll();
  const box = $("historyList");

  if(!list.length){
    box.innerHTML = `<div class="hint">Nenhuma avalia√ß√£o salva ainda.</div>`;
    return;
  }

  box.innerHTML = list.map(it=>{
    const asa = it.asa ? `ASA ${it.asa}` : "";
    const mp = it.mallampati ? `Mallampati ${it.mallampati}` : "";
    return `
      <div class="historyItem">
        <div class="historyTitle">${escapeHtml(it.paciente)}</div>
        <div class="historySub">${escapeHtml(it.procedimento)}</div>
        <div class="historyMeta">${escapeHtml([asa, mp].filter(Boolean).join(" ‚Ä¢ "))}</div>
        <button class="btn btnGhost" onclick="viewHistory('${it.id}')">Ver resumo</button>
        <button class="btn btnPrimary" onclick="pdfFromHistory('${it.id}')">PDF</button>
      </div>
    `;
  }).join("");
}

function viewHistory(id){
  const list = readAll();
  const it = list.find(x=>x.id===id);
  if(!it){ toast("Item n√£o encontrado"); return; }
  $("summaryText").value = it.resumo || "";
  showScreen("screenSummary");
}

function clearHistory(){
  if(!confirm("Apagar todo o hist√≥rico do aparelho?")) return;
  localStorage.removeItem(STORAGE_KEY);
  renderHistory();
  toast("Hist√≥rico apagado.");
}

// =====================
// PDF premium (capa + foto + 2¬™ p√°gina)
// =====================

function pdfFromSummary(){
  // usa o draft atual
  collectCurrentStep();
  const payload = {
    paciente: draft.paciente,
    idade: draft.idade,
    asa: draft.asa,
    procedimento: draft.procedimento,
    mallampati: draft.mallampati,
    comorbidades: draft.comorbidades,
    medicacoes: draft.medicacoes,
    estrategia: draft.estrategia,
    conduta: draft.conduta,
    consentimento: draft.consentimento,
    fotoData: draft.fotoData
  };
  openPdfWindow(payload);
}

function pdfFromHistory(id){
  const list = readAll();
  const it = list.find(x=>x.id===id);
  if(!it){ toast("Item n√£o encontrado"); return; }
  const d = it.data || {};
  const payload = {
    paciente: d.paciente || it.paciente,
    idade: d.idade || it.idade || "",
    asa: d.asa || it.asa || "",
    procedimento: d.procedimento || it.procedimento,
    mallampati: d.mallampati || it.mallampati,
    comorbidades: d.comorbidades || "",
    medicacoes: d.medicacoes || "",
    estrategia: d.estrategia || "",
    conduta: d.conduta || "",
    consentimento: d.consentimento || "Consentimento informado obtido.",
    fotoData: d.fotoData || ""
  };
  openPdfWindow(payload);
}

function openPdfWindow(p){
  const doctorLine = "Dr Leonardo Alves Ara√∫jo ‚Ä¢ CRM-MG 47310 ‚Ä¢ RQE 40542";
  const idadeTxt = p.idade ? `${p.idade} anos` : "";
  const asaTxt = p.asa ? `ASA ${p.asa}` : "";
  const header2 = [idadeTxt, asaTxt].filter(Boolean).join(" ‚Ä¢ ");

  // ‚ÄúLogo minimalista‚Äù = wordmark
  const logo = "Pr√©via";

  const fotoHtml = p.fotoData
    ? `<img class="photo" src="${p.fotoData}" alt="Foto do paciente" />`
    : `<div class="photo photoEmpty">Foto n√£o adicionada</div>`;

  const safe = (x)=>escapeHtml(x||"");

  const html = `
<!doctype html>
<html>
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Pr√©via anest√©sica</title>
<style>
  :root{ --ink:#0b1f33; --muted:#5a6b7b; --line:#e6edf3; }
  *{ box-sizing:border-box; }
  body{ margin:0; font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Arial; color:var(--ink); }
  .page{ padding:28px 34px; }
  .topRow{ display:flex; align-items:flex-start; justify-content:space-between; gap:18px; }
  .logo{
    font-weight:800; letter-spacing:0.5px; font-size:22px;
    padding:10px 14px; border:1px solid var(--line); border-radius:14px;
  }
  .doctor{ text-align:right; font-size:12px; color:var(--muted); margin-top:6px; }
  .title{ margin:22px 0 10px; font-size:18px; font-weight:800; }
  .card{
    border:1px solid var(--line); border-radius:16px; padding:16px;
  }
  .grid{ display:grid; grid-template-columns: 1.1fr 0.9fr; gap:16px; align-items:start; }
  .label{ font-size:11px; color:var(--muted); text-transform:uppercase; letter-spacing:.08em; margin-top:10px; }
  .value{ font-size:14px; margin-top:4px; white-space:pre-wrap; }
  .photo{
    width:100%; height:260px; object-fit:cover;
    border-radius:16px; border:1px solid var(--line);
  }
  .photoEmpty{
    display:flex; align-items:center; justify-content:center;
    color:var(--muted); font-size:12px; background:#f7fafc;
  }
  .sep{ height:1px; background:var(--line); margin:14px 0; }
  .small{ font-size:13px; color:var(--muted); }
  .h2{ font-size:16px; font-weight:800; margin:0 0 10px; }
  .pageBreak{ page-break-before:always; }
  @media print{
    .noPrint{ display:none !important; }
    body{ -webkit-print-color-adjust:exact; print-color-adjust:exact; }
  }
</style>
</head>
<body>

<!-- CAPA -->
<div class="page">
  <div class="topRow">
    <div class="logo">${logo}</div>
    <div>
      <div class="doctor">${doctorLine}</div>
    </div>
  </div>

  <div class="title">Pr√©via anest√©sica</div>

  <div class="grid">
    <div class="card">
      <div class="label">Paciente</div>
      <div class="value"><b>${safe(p.paciente || "‚Äî")}</b></div>

      <div class="label">Resumo</div>
      <div class="value">
        <b>Procedimento:</b> ${safe(p.procedimento || "‚Äî")}<br/>
        ${header2 ? `<span class="small">${safe(header2)}</span><br/>` : ``}
        <b>Mallampati:</b> ${safe(p.mallampati || "‚Äî")}<br/><br/>

        <b>Comorbidades:</b> ${safe(p.comorbidades || "‚Äî")}<br/>
        <b>Medica√ß√µes:</b> ${safe(p.medicacoes || "‚Äî")}<br/><br/>

        <b>Estrat√©gia anest√©sica:</b><br/>
        ${safe(p.estrategia || "‚Äî")}<br/><br/>

        <b>Conduta:</b><br/>
        ${safe(p.conduta || "‚Äî")}<br/><br/>

        <span class="small">${safe(p.consentimento || "")}</span>
      </div>

      <div class="sep"></div>
      <div class="small">
        Documento gerado para facilitar comunica√ß√£o entre paciente, cirurgi√£o e anestesiologista.
        Recomenda√ß√µes finais devem ser confirmadas no dia do procedimento conforme evolu√ß√£o cl√≠nica.
      </div>
    </div>

    <div>
      ${fotoHtml}
    </div>
  </div>

  <div class="noPrint" style="padding:18px 0 0;">
    <button onclick="window.print()" style="padding:12px 16px;border-radius:12px;border:1px solid #d9e5ee;background:#0b3b66;color:#fff;font-weight:700;">
      Imprimir / Salvar como PDF
    </button>
    <span style="margin-left:10px;color:#5a6b7b;font-size:12px;">(No iPhone: Compartilhar ‚Üí Imprimir ‚Üí ‚Äúpin√ßa‚Äù pra virar PDF)</span>
  </div>
</div>

<!-- 2¬™ P√ÅGINA: Estrat√©gia + Consentimento (placeholder) -->
<div class="page pageBreak">
  <div class="topRow">
    <div class="logo">${logo}</div>
    <div class="doctor">${doctorLine}</div>
  </div>

  <div style="margin-top:18px" class="card">
    <div class="h2">Estrat√©gia anest√©sica</div>
    <div class="value">${safe(p.estrategia || "‚Äî")}</div>
  </div>

  <div style="margin-top:14px" class="card">
    <div class="h2">Termo de consentimento livre e esclarecido (resumo)</div>
    <div class="value">
      Declaro que fui informado(a) sobre o tipo de anestesia planejada, benef√≠cios, riscos e alternativas,
      incluindo poss√≠veis intercorr√™ncias e necessidade de mudan√ßas na t√©cnica conforme seguran√ßa cl√≠nica.
      Tive oportunidade de esclarecer d√∫vidas, e autorizo a realiza√ß√£o do ato anest√©sico.
      <br/><br/>
      <b>Registro:</b> ${safe(p.consentimento || "Consentimento informado obtido.")}
      <br/><br/><br/>
      _______________________________________<br/>
      Assinatura do(a) paciente / respons√°vel
      <br/><br/>
      _______________________________________<br/>
      Assinatura do(a) anestesiologista
    </div>
  </div>
</div>

</body>
</html>
  `.trim();

  const w = window.open("", "_blank");
  if(!w){ toast("Pop-up bloqueado. Tente novamente."); return; }
  w.document.open();
  w.document.write(html);
  w.document.close();
}

// =====================
// Hook bot√µes existentes
// =====================
function pdfFromSummaryBtn(){ pdfFromSummary(); }

// =====================
// Inicializa√ß√£o
// =====================
function init(){
  // Tela inicial: Home
  showScreen("screenHome");
  // Preenche hist√≥rico se j√° tiver
  renderHistory();
}
init();
} 