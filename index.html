<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Prévia</title>
<link rel="stylesheet" href="styles.css">

<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

<style>
.hidden { display:none; }
</style>
</head>

<body>

<header class="topbar">
  <div class="logoDot"></div>
  <div>
    <div class="logo">Prévia</div>
    <div class="subtitle">Dr Leonardo Alves Araújo • CRM-MG 47310 • RQE 40542</div>
  </div>
</header>

<!-- HOME -->
<div class="card" id="screenHome">
  <h2>Home</h2>
  <p>Fazer avaliação em <b>8 etapas</b>, salvar e gerar PDF.</p>

  <button class="btnPrimary" onclick="start()">Nova avaliação</button>
  <button class="btnGhost" onclick="openHistory()">Histórico</button>
</div>

<!-- STEP -->
<div class="card hidden" id="screenStep">
  <h2 id="stepTitle"></h2>

  <div id="stepBody"></div>

  <div class="btnRow">
    <button class="btnGhost" onclick="prevStep()">Voltar</button>
    <button class="btnPrimary" onclick="nextStep()">Avançar</button>
  </div>
</div>

<!-- HISTORY -->
<div class="card hidden" id="screenHistory">
  <h2>Histórico</h2>
  <div id="historyList"></div>

  <div class="btnRow">
    <button class="btnGhost" onclick="goHome()">Home</button>
    <button class="btnDanger" onclick="clearHistory()">Apagar tudo</button>
  </div>
</div>

<script>

const steps = [
"Identificação",
"Procedimento",
"Histórico",
"Clínico",
"Alto impacto",
"Via aérea",
"Estratégia",
"Conduta"
]

let step = 0
let data = {}

function start(){
  step=0
  data={}
  showStep()
}

function showStep(){
  document.getElementById("screenHome").classList.add("hidden")
  document.getElementById("screenHistory").classList.add("hidden")
  document.getElementById("screenStep").classList.remove("hidden")

  document.getElementById("stepTitle").innerText = steps[step]

  let html=""

  if(step==0){
    html=`
    <label>Paciente</label>
    <input id="paciente">
    <label>Idade</label>
    <input id="idade">
    <label>ASA</label>
    <select id="asa">
      <option>I</option><option>II</option><option>III</option>
    </select>
    `
  }

  if(step==1){
    html=`
    <label>Procedimento</label>
    <input id="procedimento">
    `
  }

  if(step==2){
    html=`
    <label>Comorbidades</label>
    <textarea id="comorb"></textarea>
    <label>Medicações</label>
    <textarea id="medic"></textarea>
    `
  }

  if(step==3){
    html=`
    <label>Exame físico relevante</label>
    <textarea id="fisico"></textarea>
    `
  }

  if(step==4){
    html=`
    <label>Risco cirúrgico</label>
    <textarea id="risco"></textarea>
    `
  }

  if(step==5){
    html=`
    <label>Mallampati</label>
    <select id="mall">
      <option>I</option><option>II</option><option>III</option><option>IV</option>
    </select>
    `
  }

  if(step==6){
    html=`
    <label>Estratégia anestésica</label>
    <textarea id="estrat"></textarea>
    `
  }

  if(step==7){
    html=`
    <label>Condição</label>
    <input id="cond">
    <label>Conduta</label>
    <textarea id="conduta"></textarea>
    `
  }

  document.getElementById("stepBody").innerHTML = html
}

function nextStep(){
  saveStep()

  if(step<steps.length-1){
    step++
    showStep()
  }else{
    saveEval()
    generatePDF()
    goHome()
  }
}

function prevStep(){
  if(step>0){
    step--
    showStep()
  }else{
    goHome()
  }
}

function saveStep(){
  const inputs = document.querySelectorAll("#stepBody input, #stepBody textarea, #stepBody select")
  inputs.forEach(i=>data[i.id]=i.value)
}

function saveEval(){
  let hist = JSON.parse(localStorage.getItem("previaHist")||"[]")
  hist.unshift(data)
  localStorage.setItem("previaHist",JSON.stringify(hist))
}

function openHistory(){
  document.getElementById("screenHome").classList.add("hidden")
  document.getElementById("screenHistory").classList.remove("hidden")

  let hist = JSON.parse(localStorage.getItem("previaHist")||"[]")
  let html=""

  hist.forEach(h=>{
    html+=`
    <div class="histCard">
      <b>${h.paciente||"Sem nome"}</b><br>
      ${h.procedimento||""} • ASA ${h.asa||""}
    </div>
    `
  })

  document.getElementById("historyList").innerHTML=html
}

function clearHistory(){
  localStorage.removeItem("previaHist")
  openHistory()
}

function goHome(){
  document.getElementById("screenHome").classList.remove("hidden")
  document.getElementById("screenStep").classList.add("hidden")
  document.getElementById("screenHistory").classList.add("hidden")
}

async function generatePDF(){
  const { jsPDF } = window.jspdf
  const doc = new jsPDF()

  doc.setFontSize(14)
  doc.text("Prévia anestésica",10,10)

  let y=20
  Object.entries(data).forEach(([k,v])=>{
    if(v){
      doc.text(k+": "+v,10,y)
      y+=8
    }
  })

  doc.save("previa.pdf")
}

</script>

</body>
</html>