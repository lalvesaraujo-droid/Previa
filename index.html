<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Prévia</title>

<style>
body{
  margin:0;
  font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto;
  background:linear-gradient(180deg,#0f2a44,#1e4d6b);
  color:white;
}
.container{
  max-width:480px;
  margin:auto;
  padding:20px;
}
.card{
  background:rgba(255,255,255,0.08);
  border-radius:18px;
  padding:20px;
  margin-top:20px;
  backdrop-filter:blur(10px);
}
input,textarea,select{
  width:100%;
  margin-top:6px;
  margin-bottom:14px;
  padding:12px;
  border-radius:12px;
  border:none;
  font-size:16px;
}
button{
  padding:12px 18px;
  border:none;
  border-radius:12px;
  font-size:16px;
  margin:6px;
}
.primary{background:#3b82f6;color:white;}
.secondary{background:rgba(255,255,255,0.2);color:white;}
.danger{background:#ef4444;color:white;}
.hidden{display:none;}
.stepTitle{font-size:20px;margin-bottom:10px;}
.historyItem{
  background:rgba(255,255,255,0.1);
  padding:14px;
  border-radius:12px;
  margin-bottom:10px;
}
</style>
</head>

<body>
<div class="container">

<h1>Prévia</h1>
<div>Dr Leonardo Alves Araújo • CRM-MG 47310 • RQE 40542</div>

<!-- HOME -->
<div id="home" class="card">
<h2>Home</h2>
<button class="primary" onclick="start()">Nova avaliação</button>
<button class="secondary" onclick="showHistory()">Histórico</button>
</div>

<!-- FORM -->
<div id="formCard" class="card hidden">
<div id="stepTitle" class="stepTitle"></div>
<div id="stepContent"></div>

<div style="text-align:center">
<button class="secondary" onclick="prev()">Voltar</button>
<button class="primary" onclick="next()">Próximo</button>
</div>
</div>

<!-- HISTORY -->
<div id="historyCard" class="card hidden">
<h2>Histórico</h2>
<div id="historyList"></div>
<button class="secondary" onclick="goHome()">Home</button>
<button class="danger" onclick="clearHistory()">Apagar tudo</button>
</div>

</div>

<script>
const steps=[
"Identificação",
"Procedimento",
"Histórico",
"Clínico",
"Alto impacto",
"Via aérea",
"Estratégia",
"Conduta"
];

let current=0;
let data={};
let fotoBase64="";

function start(){
current=0;
data={};
fotoBase64="";
document.getElementById("home").classList.add("hidden");
document.getElementById("formCard").classList.remove("hidden");
renderStep();
}

function renderStep(){
document.getElementById("stepTitle").innerText=steps[current];
let html="";

if(current===0){
html+=`Paciente<input id="paciente">`;
html+=`Idade<input id="idade">`;
html+=`ASA<select id="asa">
<option>I</option><option>II</option><option>III</option><option>IV</option>
</select>`;
}

if(current===1){
html+=`Procedimento<input id="procedimento">`;
}

if(current===2){
html+=`Comorbidades<textarea id="comorbidades"></textarea>`;
}

if(current===3){
html+=`Medicações<textarea id="medicacoes"></textarea>`;
}

if(current===4){
html+=`Risco cirúrgico<textarea id="risco"></textarea>`;
}

if(current===5){
html+=`Mallampati<select id="mallampati">
<option>I</option><option>II</option><option>III</option><option>IV</option>
</select>`;
}

if(current===6){
html+=`Estratégia anestésica<textarea id="estrategia"></textarea>`;
}

if(current===7){
html+=`Condição<input id="condicao">`;
html+=`Conduta<textarea id="conduta"></textarea>`;
html+=`Foto<input type="file" id="foto">`;
}

document.getElementById("stepContent").innerHTML=html;
}

function saveStep(){
if(current===0){
data.paciente=document.getElementById("paciente").value;
data.idade=document.getElementById("idade").value;
data.asa=document.getElementById("asa").value;
}
if(current===1) data.procedimento=document.getElementById("procedimento").value;
if(current===2) data.comorbidades=document.getElementById("comorbidades").value;
if(current===3) data.medicacoes=document.getElementById("medicacoes").value;
if(current===4) data.risco=document.getElementById("risco").value;
if(current===5) data.mallampati=document.getElementById("mallampati").value;
if(current===6) data.estrategia=document.getElementById("estrategia").value;
if(current===7){
data.condicao=document.getElementById("condicao").value;
data.conduta=document.getElementById("conduta").value;

const file=document.getElementById("foto").files[0];
if(file){
const reader=new FileReader();
reader.onload=()=>fotoBase64=reader.result;
reader.readAsDataURL(file);
}
}
}

function next(){
saveStep();
if(current<steps.length-1){
current++;
renderStep();
}else{
saveEvaluation();
}
}

function prev(){
if(current>0){
current--;
renderStep();
}else{
goHome();
}
}

function saveEvaluation(){
data.foto=fotoBase64;
let hist=JSON.parse(localStorage.getItem("previa_hist")||"[]");
hist.unshift(data);
localStorage.setItem("previa_hist",JSON.stringify(hist));
generatePDF(data);
goHome();
}

function showHistory(){
document.getElementById("home").classList.add("hidden");
document.getElementById("historyCard").classList.remove("hidden");

let hist=JSON.parse(localStorage.getItem("previa_hist")||"[]");
let html="";
hist.forEach(it=>{
html+=`<div class="historyItem">
<b>${it.paciente||"Sem nome"}</b><br>
${it.procedimento||""}<br>
ASA ${it.asa||""} • Mallampati ${it.mallampati||""}
</div>`;
});
document.getElementById("historyList").innerHTML=html;
}

function clearHistory(){
localStorage.removeItem("previa_hist");
showHistory();
}

function goHome(){
document.getElementById("formCard").classList.add("hidden");
document.getElementById("historyCard").classList.add("hidden");
document.getElementById("home").classList.remove("hidden");
}

function generatePDF(d){
let win=window.open("","_blank");
let html=`
<html><body style="font-family:Arial;padding:40px">

<h1 style="color:#0f2a44">Prévia anestésica</h1>
<h2>${d.paciente||""}</h2>

${d.foto?`<img src="${d.foto}" style="width:120px;border-radius:10px"><br>`:""}

<b>Procedimento:</b> ${d.procedimento||""}<br>
<b>ASA:</b> ${d.asa||""}<br>
<b>Mallampati:</b> ${d.mallampati||""}<br>
<b>Comorbidades:</b> ${d.comorbidades||""}<br>
<b>Medicações:</b> ${d.medicacoes||""}<br>

<h2>Estratégia anestésica</h2>
${d.estrategia||""}

<h2>Conduta</h2>
${d.conduta||""}

<hr>
<p>Consentimento informado obtido.</p>

</body></html>
`;
win.document.write(html);
win.document.close();
}
</script>
</body>
</html>