<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>Prévia</title>

  <!-- jsPDF -->
  <script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>
  <!-- QRCode -->
  <script src="https://cdn.jsdelivr.net/npm/qrcode@1.5.4/build/qrcode.min.js"></script>

  <style>
    :root{
      --bg:#071c2e;
      --bg2:#0f2f4b;
      --card: rgba(255,255,255,.09);
      --stroke: rgba(255,255,255,.14);
      --text: rgba(255,255,255,.92);
      --muted: rgba(255,255,255,.68);
      --blue:#2f6bff;
      --green:#1fbf63;
      --red:#ff3b30;
      --radius: 18px;
      --shadow: 0 18px 60px rgba(0,0,0,.35);
      --max: 980px;
    }

    *{box-sizing:border-box}
    body{
      margin:0;
      font-family:-apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial;
      background: radial-gradient(1200px 700px at 20% 0%, #154c78 0%, var(--bg) 45%, #051626 100%);
      color: var(--text);
      min-height:100vh;
    }
    .wrap{ max-width: var(--max); margin:0 auto; padding: 18px 14px 80px; }

    .top{
      display:flex; align-items:flex-start; justify-content:space-between; gap:12px;
      margin-bottom: 14px;
    }
    .brand h1{ margin:0; font-size: 40px; line-height:1; letter-spacing:.2px;}
    .brand .sub{ margin-top:6px; color: var(--muted); line-height:1.35; }
    .pill{
      padding:10px 12px;
      border:1px solid var(--stroke);
      border-radius:999px;
      background: rgba(255,255,255,.07);
      color: var(--muted);
      font-size: 13px;
      white-space:nowrap;
    }

    .grid{ display:grid; grid-template-columns:1fr; gap:14px; }
    @media(min-width:820px){ .grid{ grid-template-columns: 1.25fr .75fr; } }

    .card{
      background: linear-gradient(180deg, rgba(255,255,255,.10), rgba(255,255,255,.06));
      border: 1px solid var(--stroke);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      padding: 16px;
    }

    h2{ margin:0 0 10px 0; font-size: 26px; }
    h3{ margin: 0 0 10px 0; font-size: 18px; }
    .muted{ color: var(--muted); }

    label{ display:block; font-size: 13px; color: var(--muted); margin: 10px 0 6px; }
    input,select,textarea{
      width:100%;
      padding: 12px 12px;
      border-radius: 14px;
      border:1px solid rgba(255,255,255,.18);
      background: rgba(255,255,255,.92);
      color:#0b2033;
      outline:none;
      font-size: 15px;
    }
    textarea{ min-height: 90px; resize: vertical; }

    .row2{ display:grid; grid-template-columns:1fr; gap:10px; }
    @media(min-width:820px){ .row2{ grid-template-columns:1fr 1fr; } }

    .btnrow{ display:flex; flex-wrap:wrap; gap:10px; margin-top: 12px; }
    button{
      border:0;
      border-radius: 14px;
      padding: 12px 14px;
      font-weight: 800;
      font-size: 15px;
      cursor:pointer;
    }
    .btn{ background: rgba(255,255,255,.12); color: var(--text); border:1px solid rgba(255,255,255,.16); }
    .primary{ background: var(--blue); color:#fff; }
    .success{ background: var(--green); color:#052014; }
    .danger{ background: var(--red); color:#fff; }

    .wizardTop{
      display:flex; align-items:center; justify-content:space-between; gap:10px; margin-bottom: 10px;
    }
    .stepPill{
      font-size: 12px; color: var(--muted);
      border:1px solid var(--stroke);
      background: rgba(255,255,255,.06);
      padding: 8px 10px;
      border-radius: 999px;
      white-space:nowrap;
    }
    .progress{ height:10px; border-radius:999px; border:1px solid rgba(255,255,255,.18); background: rgba(0,0,0,.12); overflow:hidden; flex:1; }
    .bar{ height:100%; width:0%; background: linear-gradient(90deg, #2f6bff, #46d1ff); border-radius:999px; transition: width .25s ease; }

    .step{ display:none; padding-top: 6px; }
    .step.active{ display:block; }

    .summary{
      white-space: pre-wrap;
      font-size: 14px;
      line-height: 1.35;
      background: rgba(0,0,0,.14);
      border:1px solid rgba(255,255,255,.14);
      border-radius: 14px;
      padding: 12px;
      min-height: 90px;
    }

    .sigWrap{ display:grid; grid-template-columns:1fr; gap:12px; margin-top: 8px; }
    @media(min-width:820px){ .sigWrap{ grid-template-columns:1fr 1fr; } }
    .sigBox{ background: rgba(255,255,255,.08); border:1px solid rgba(255,255,255,.14); border-radius: 16px; padding: 12px; }
    canvas{
      width:100%;
      height: 170px;
      background: rgba(255,255,255,.96);
      border-radius: 14px;
      border:1px solid rgba(0,0,0,.10);
      touch-action: none;
    }

    .dock{
      position: fixed; left:0; right:0; bottom:0;
      background: rgba(5, 22, 38, .72);
      border-top: 1px solid rgba(255,255,255,.12);
      backdrop-filter: blur(10px);
      padding: 10px 12px calc(10px + env(safe-area-inset-bottom));
      z-index: 20;
    }
    .dockInner{
      max-width: var(--max);
      margin: 0 auto;
      display:flex; align-items:center; justify-content:space-between; gap:10px; flex-wrap:wrap;
      color: var(--muted);
      font-size: 12px;
    }
    .badge{
      border:1px solid rgba(255,255,255,.16);
      background: rgba(255,255,255,.08);
      padding: 8px 10px;
      border-radius: 999px;
      font-size: 12px;
      color: var(--muted);
    }
    .hr{ height:1px; background: rgba(255,255,255,.14); margin: 14px 0; }
  </style>
</head>

<body>
  <div class="wrap">
    <div class="top">
      <div class="brand">
        <h1>Prévia</h1>
        <div class="sub">
          plataforma de avaliação pré-anestésica<br>
          <span class="muted">Dr Leonardo Alves Araújo • CRM-MG 47310 • RQE 40542</span>
        </div>
      </div>
      <div class="pill">PRV-26 • QR • PDF • versões</div>
    </div>

    <div class="grid">
      <!-- LEFT -->
      <div class="card">
        <div class="wizardTop">
          <div class="stepPill" id="stepLabel">Etapa 1 de 6</div>
          <div class="progress"><div class="bar" id="bar"></div></div>
        </div>

        <!-- STEP 1 -->
        <div class="step active" data-step="1">
          <h2>Identificação</h2>

          <div class="row2">
            <div>
              <label>ID Prévia</label>
              <input id="pid" readonly />
            </div>
            <div>
              <label>Versão</label>
              <input id="pver" readonly />
            </div>
          </div>

          <div class="row2">
            <div>
              <label>Modo</label>
              <select id="modo">
                <option value="hospital">Clínica / Hospital</option>
                <option value="estetica">Estética</option>
              </select>
            </div>
            <div>
              <label>Logo na capa</label>
              <select id="logoModo">
                <option value="word">“Prévia” grande</option>
                <option value="icon">Ícone “P” grande</option>
                <option value="none">Sem logo</option>
              </select>
            </div>
          </div>

          <div class="row2">
            <div>
              <label>Nome do paciente</label>
              <input id="nome" placeholder="Nome completo" />
            </div>
            <div>
              <label>Procedimento</label>
              <input id="proced" placeholder="Ex.: Mamoplastia / Hernioplastia..." />
            </div>
          </div>

          <div class="row2">
            <div>
              <label>ASA</label>
              <input id="asa" placeholder="Ex.: II" />
            </div>
            <div>
              <label>Mallampati</label>
              <input id="mall" placeholder="Ex.: II" />
            </div>
          </div>

          <div class="btnrow">
            <button class="primary" onclick="novaAvaliacao()">Nova avaliação (gera novo PRV-26)</button>
            <button class="btn" onclick="scrollToHistorico()">Histórico</button>
          </div>
        </div>

        <!-- STEP 2 -->
        <div class="step" data-step="2">
          <h2>Dados clínicos</h2>
          <label>Comorbidades</label>
          <textarea id="comorb" placeholder="HAS, DM, asma..."></textarea>

          <label>Medicações</label>
          <textarea id="meds" placeholder="Losartana 50mg 1x/d..."></textarea>

          <label>Alergias</label>
          <textarea id="alerg" placeholder="Dipirona (urticária)..."></textarea>
        </div>

        <!-- STEP 3 -->
        <div class="step" data-step="3">
          <h2>História</h2>
          <label>Passado cirúrgico</label>
          <textarea id="cirurg" placeholder="Cesariana (3x) sem intercorrências..."></textarea>

          <label>Intercorrências anestésicas anteriores</label>
          <textarea id="interc" placeholder="PONV, difícil intubação, alergia..."></textarea>
        </div>

        <!-- STEP 4 -->
        <div class="step" data-step="4">
          <h2>Estratégia</h2>
          <label>Estratégia anestésica</label>
          <textarea id="estrat" placeholder="Geral + multimodal / bloqueio..."></textarea>

          <label>Conduta (jejum, ajustes, orientações)</label>
          <textarea id="cond" placeholder="Jejum 8h sólidos; água até 2h..."></textarea>
        </div>

        <!-- STEP 5 -->
        <div class="step" data-step="5">
          <h2>Consentimento + Anexos</h2>

          <label>Texto do consentimento (resumido)</label>
          <textarea id="consent"></textarea>

          <div class="btnrow">
            <button class="btn" onclick="inserirConsent('hospital')">Padrão Hospital</button>
            <button class="btn" onclick="inserirConsent('estetica')">Padrão Estética</button>
          </div>

          <div class="hr"></div>

          <h3>Anexos</h3>
          <label>Foto do paciente (capa)</label>
          <input type="file" id="fotoCapa" accept="image/*" />

          <label>Via aérea (foto)</label>
          <input type="file" id="fotoVia" accept="image/*" />

          <label>Exames relevantes (múltiplos)</label>
          <input type="file" id="exames" accept="image/*" multiple />
        </div>

        <!-- STEP 6 -->
        <div class="step" data-step="6">
          <h2>Resumo + Assinaturas + PDF</h2>

          <div class="btnrow">
            <button class="btn" onclick="atualizarResumo()">Atualizar resumo</button>
            <button class="success" onclick="gerarPDFPremium()">Gerar PDF Premium</button>
          </div>

          <div class="hr"></div>

          <h3>Resumo rápido</h3>
          <div class="summary" id="resumoBox"></div>

          <div class="hr"></div>

          <h3>Assinaturas</h3>
          <div class="sigWrap">
            <div class="sigBox">
              <div class="muted" style="font-weight:800;margin-bottom:8px">Paciente</div>
              <canvas id="sigPaciente" width="900" height="360"></canvas>
              <div class="btnrow">
                <button class="btn" onclick="limparCanvas('sigPaciente')">Limpar</button>
              </div>
            </div>

            <div class="sigBox">
              <div class="muted" style="font-weight:800;margin-bottom:8px">Médico</div>
              <canvas id="sigMedico" width="900" height="360"></canvas>
              <div class="btnrow">
                <button class="btn" onclick="limparCanvas('sigMedico')">Limpar</button>
              </div>
            </div>
          </div>

          <div class="hr"></div>

          <h3>Salvar / Versões</h3>
          <div class="muted">Salvar atual atualiza v{n}. “Nova versão” cria v{n+1} no mesmo PRV-26.</div>
          <div class="btnrow">
            <button class="btn" onclick="salvarAtual()">Salvar (atualizar versão)</button>
            <button class="primary" onclick="salvarNova()">Salvar nova versão (v+1)</button>
          </div>
        </div>

        <div class="btnrow">
          <button class="btn" id="btnPrev" onclick="prevStep()">Voltar</button>
          <button class="primary" id="btnNext" onclick="nextStep()">Continuar</button>
        </div>
      </div>

      <!-- RIGHT -->
      <div class="card">
        <h2>Histórico</h2>
        <div class="muted">Busca por PRV e versões. (localStorage — demo)</div>

        <label>Buscar (PRV ou nome)</label>
        <input id="buscar" placeholder="Ex.: PRV-26-000012 ou Paula" oninput="renderHistorico()" />

        <div class="btnrow">
          <button class="btn" onclick="renderHistorico()">Atualizar</button>
          <button class="btn" onclick="limparHistorico()">Limpar histórico (demo)</button>
        </div>

        <div class="hr"></div>
        <div id="histList" class="muted">Carregando…</div>
      </div>
    </div>
  </div>

  <div class="dock">
    <div class="dockInner">
      <div style="display:flex;gap:8px;flex-wrap:wrap">
        <span class="badge" id="badgeID">ID: —</span>
        <span class="badge" id="badgeV">v1</span>
        <span class="badge" id="badgeModo">modo: hospital</span>
      </div>
      <div class="muted">Prévia • PRV-26 • QR • PDF Premium</div>
    </div>
  </div>

<script>
  /********************
   * PRV-26 (sequencial)
   ********************/
  const YEAR2 = "26";
  const SEQ_KEY = "previa_seq_" + YEAR2;           // contador global do ano
  const STORE_KEY = "previa_hist_" + YEAR2 + "_v1"; // histórico

  function pad6(n){ return String(n).padStart(6,"0"); }
  function nextPRV(){
    const cur = parseInt(localStorage.getItem(SEQ_KEY) || "0", 10);
    const nxt = cur + 1;
    localStorage.setItem(SEQ_KEY, String(nxt));
    return `PRV-${YEAR2}-${pad6(nxt)}`;
  }

  /********************
   * Estado
   ********************/
  let step = 1;
  const stepsTotal = 6;

  let currentId = null;     // PRV-26-000001
  let currentVersion = 1;   // v1, v2...

  const el = (id)=>document.getElementById(id);

  function nowISO(){ return new Date().toISOString(); }
  function safe(t){ return (t||"").trim(); }

  function atualizarBadges(){
    el("badgeID").textContent = "ID: " + (currentId || "—");
    el("badgeV").textContent = "v" + (currentVersion || 1);
    el("badgeModo").textContent = "modo: " + (el("modo").value || "hospital");
    el("pid").value = currentId || "";
    el("pver").value = "v" + (currentVersion || 1);
  }

  /********************
   * Wizard
   ********************/
  function renderStep(){
    document.querySelectorAll(".step").forEach(s=>s.classList.remove("active"));
    const active = document.querySelector(`.step[data-step="${step}"]`);
    if(active) active.classList.add("active");

    el("stepLabel").textContent = `Etapa ${step} de ${stepsTotal}`;
    el("bar").style.width = `${Math.round((step-1)/(stepsTotal-1)*100)}%`;

    el("btnPrev").disabled = (step===1);
    el("btnPrev").style.opacity = (step===1 ? .5 : 1);
    el("btnNext").textContent = (step===stepsTotal ? "Pronto" : "Continuar");

    if(step===6) atualizarResumo();
    atualizarBadges();
    window.scrollTo({top:0, behavior:"smooth"});
  }
  function nextStep(){ if(step<stepsTotal) step++; renderStep(); }
  function prevStep(){ if(step>1) step--; renderStep(); }
  function scrollToHistorico(){ el("histList").scrollIntoView({behavior:"smooth", block:"start"}); }

  /********************
   * Consentimento
   ********************/
  function consentBase(tipo){
    const comum =
`TERMO DE CONSENTIMENTO INFORMADO – ANESTESIA (RESUMIDO)

Declaro que recebi explicações claras sobre a anestesia proposta, seus benefícios e riscos. Entendo que toda anestesia envolve riscos, ainda que raros, como náuseas e vômitos, dor de garganta, reações alérgicas, alterações de pressão, necessidade de medicamentos adicionais, conversão de técnica, ou suporte ventilatório/circulatório.

Fui informado(a) que o plano anestésico pode ser ajustado conforme a avaliação clínica, exames e condições do ato anestésico-cirúrgico. Autorizo a realização de procedimentos necessários à segurança, incluindo acesso venoso, monitorização, analgesia e medidas de prevenção de náuseas/dor.`;

    const esteticaPlus =
`\n\n(Procedimentos estéticos) Reconheço que o procedimento é eletivo e que a segurança anestésica depende do cumprimento de jejum, orientações e comunicação completa de doenças, alergias e medicações.`;

    const fim =
`\n\nLocal e data: ________________________________
Assinatura do(a) paciente/responsável: ________________________________
Assinatura do médico anestesiologista: ________________________________`;

    return (tipo==="estetica") ? (comum + esteticaPlus + fim) : (comum + fim);
  }
  function inserirConsent(tipo){
    el("consent").value = consentBase(tipo);
  }

  /********************
   * Form data
   ********************/
  function getFormData(){
    return {
      modo: el("modo").value,
      logoModo: el("logoModo").value,
      nome: safe(el("nome").value),
      proced: safe(el("proced").value),
      asa: safe(el("asa").value),
      mall: safe(el("mall").value),
      comorb: safe(el("comorb").value),
      meds: safe(el("meds").value),
      alerg: safe(el("alerg").value),
      cirurg: safe(el("cirurg").value),
      interc: safe(el("interc").value),
      estrat: safe(el("estrat").value),
      cond: safe(el("cond").value),
      consent: safe(el("consent").value),
    };
  }

  function setFormData(d){
    el("modo").value = d.modo || "hospital";
    el("logoModo").value = d.logoModo || "word";
    el("nome").value = d.nome || "";
    el("proced").value = d.proced || "";
    el("asa").value = d.asa || "";
    el("mall").value = d.mall || "";
    el("comorb").value = d.comorb || "";
    el("meds").value = d.meds || "";
    el("alerg").value = d.alerg || "";
    el("cirurg").value = d.cirurg || "";
    el("interc").value = d.interc || "";
    el("estrat").value = d.estrat || "";
    el("cond").value = d.cond || "";
    el("consent").value = d.consent || consentBase(el("modo").value==="estetica" ? "estetica":"hospital");
    atualizarBadges();
  }

  /********************
   * Resumo
   ********************/
  function oneLine(t){ return (t||"").replace(/\s+/g," ").trim(); }
  function atualizarResumo(){
    const d = getFormData();
    const lines = [];
    lines.push(`${currentId || "—"} • v${currentVersion || 1}`);
    lines.push(`${d.nome || "Paciente"} • ${d.proced || "Procedimento"} • ASA ${d.asa || "-"} • Mallampati ${d.mall || "-"}`);
    if(d.comorb) lines.push(`Comorbidades: ${oneLine(d.comorb)}`);
    if(d.meds) lines.push(`Medicações: ${oneLine(d.meds)}`);
    if(d.alerg) lines.push(`Alergias: ${oneLine(d.alerg)}`);
    if(d.cirurg) lines.push(`Passado cirúrgico: ${oneLine(d.cirurg)}`);
    if(d.interc) lines.push(`Intercorrências anestésicas: ${oneLine(d.interc)}`);
    if(d.estrat) lines.push(`Estratégia: ${oneLine(d.estrat)}`);
    if(d.cond) lines.push(`Conduta: ${oneLine(d.cond)}`);
    el("resumoBox").textContent = lines.join("\n");
  }

  /********************
   * Storage / Histórico
   ********************/
  function loadAll(){
    try{ return JSON.parse(localStorage.getItem(STORE_KEY) || "[]"); }
    catch(e){ return []; }
  }
  function saveAll(arr){ localStorage.setItem(STORE_KEY, JSON.stringify(arr)); }

  function salvarAtual(){
    if(!currentId){ currentId = nextPRV(); currentVersion = 1; }
    const all = loadAll();
    const d = getFormData();
    const idx = all.findIndex(r => r.id===currentId && r.version===currentVersion);

    const rec = {
      id: currentId,
      version: currentVersion,
      createdAt: idx>=0 ? all[idx].createdAt : nowISO(),
      updatedAt: nowISO(),
      data: d
    };

    if(idx>=0) all[idx]=rec;
    else all.unshift(rec);

    saveAll(all);
    renderHistorico();
    toast("Salvo (atualizado).");
    atualizarBadges();
  }

  function salvarNova(){
    if(!currentId){ currentId = nextPRV(); currentVersion = 1; }
    const all = loadAll();
    const d = getFormData();

    const vers = all.filter(r=>r.id===currentId).map(r=>r.version||1);
    const maxV = vers.length ? Math.max(...vers) : (currentVersion||1);
    currentVersion = maxV + 1;

    const rec = { id: currentId, version: currentVersion, createdAt: nowISO(), updatedAt: nowISO(), data: d };
    all.unshift(rec);
    saveAll(all);
    renderHistorico();
    toast("Nova versão criada (v+1).");
    atualizarBadges();
  }

  function abrirRegistro(id, version){
    const all = loadAll();
    const rec = all.find(r=>r.id===id && r.version===version);
    if(!rec){ toast("Não achei esse registro."); return; }
    currentId = rec.id;
    currentVersion = rec.version;
    setFormData(rec.data || {});
    // anexos e canvas não restauram sem backend (normal pra demo)
    toast(`Carregado ${id} v${version}.`);
    step = 1; renderStep();
  }

  function renderHistorico(){
    const q = safe(el("buscar").value).toLowerCase();
    const all = loadAll();

    if(!all.length){
      el("histList").innerHTML = `<div class="muted">Sem registros ainda. Salve uma avaliação.</div>`;
      return;
    }

    // agrupa por id
    const byId = {};
    all.forEach(r=>{
      const nome = (r.data?.nome || "").toLowerCase();
      const ok = !q || r.id.toLowerCase().includes(q) || nome.includes(q);
      if(!ok) return;
      if(!byId[r.id]) byId[r.id]=[];
      byId[r.id].push(r);
    });

    const ids = Object.keys(byId).sort((a,b)=>{
      const da = new Date(byId[a][0].updatedAt || byId[a][0].createdAt);
      const db = new Date(byId[b][0].updatedAt || byId[b][0].createdAt);
      return db-da;
    });

    if(!ids.length){
      el("histList").innerHTML = `<div class="muted">Nada encontrado pra “${el("buscar").value}”.</div>`;
      return;
    }

    let html = "";
    ids.slice(0, 30).forEach(id=>{
      const vers = byId[id].sort((a,b)=> (b.version||1)-(a.version||1));
      const top = vers[0];
      const nm = (top.data?.nome || "Paciente").slice(0, 34);
      const pr = (top.data?.proced || "Procedimento").slice(0, 34);
      const when = new Date(top.updatedAt || top.createdAt).toLocaleString("pt-BR");

      html += `
        <div style="padding:12px;border:1px solid rgba(255,255,255,.14);border-radius:16px;background:rgba(0,0,0,.12);margin-bottom:10px">
          <div style="font-weight:900;color:rgba(255,255,255,.92)">${id} <span style="color:rgba(255,255,255,.55);font-weight:700">• ${nm}</span></div>
          <div style="margin-top:6px;color:rgba(255,255,255,.60);font-size:12px">
            ${pr} • última: ${when} • versões: ${vers.length}
          </div>
          <div style="display:flex;flex-wrap:wrap;gap:8px;margin-top:10px">
            <button class="btn" onclick="abrirRegistro('${id}', ${top.version})">Abrir v${top.version}</button>
            <button class="btn" onclick="abrirRegistro('${id}', 1)">v1</button>
          </div>
        </div>
      `;
    });

    el("histList").innerHTML = html;
  }

  function limparHistorico(){
    if(!confirm("Apagar histórico (demo)?")) return;
    localStorage.removeItem(STORE_KEY);
    renderHistorico();
    toast("Histórico apagado.");
  }

  /********************
   * Nova avaliação (novo PRV)
   ********************/
  function novaAvaliacao(){
    currentId = nextPRV();
    currentVersion = 1;

    setFormData({
      modo: el("modo").value || "hospital",
      logoModo: el("logoModo").value || "word",
      consent: consentBase((el("modo").value==="estetica") ? "estetica":"hospital")
    });

    // limpa anexos e assinaturas
    el("fotoCapa").value = "";
    el("fotoVia").value = "";
    el("exames").value = "";
    limparCanvas("sigPaciente");
    limparCanvas("sigMedico");

    step = 1; renderStep();
    toast("Novo PRV-26 criado.");
  }

  /********************
   * Assinatura (canvas + iOS)
   ********************/
  function setupSignature(canvasId){
    const canvas = el(canvasId);
    const ctx = canvas.getContext("2d");
    let drawing = false;

    function pos(e){
      const rect = canvas.getBoundingClientRect();
      const t = e.touches && e.touches[0];
      const clientX = t ? t.clientX : e.clientX;
      const clientY = t ? t.clientY : e.clientY;
      return {
        x: (clientX - rect.left) * (canvas.width / rect.width),
        y: (clientY - rect.top) * (canvas.height / rect.height)
      };
    }

    function start(e){
      e.preventDefault();
      drawing = true;
      const p = pos(e);
      ctx.beginPath();
      ctx.moveTo(p.x,p.y);
    }

    function move(e){
      if(!drawing) return;
      e.preventDefault();
      const p = pos(e);
      ctx.lineTo(p.x,p.y);
      ctx.strokeStyle = "#0b2033";
      ctx.lineWidth = 4.2;
      ctx.lineCap = "round";
      ctx.lineJoin = "round";
      ctx.stroke();
    }

    function end(e){
      if(!drawing) return;
      e.preventDefault();
      drawing = false;
    }

    canvas.addEventListener("mousedown", start);
    canvas.addEventListener("mousemove", move);
    window.addEventListener("mouseup", end);

    canvas.addEventListener("touchstart", start, {passive:false});
    canvas.addEventListener("touchmove", move, {passive:false});
    window.addEventListener("touchend", end, {passive:false});
  }

  function limparCanvas(canvasId){
    const c = el(canvasId);
    const ctx = c.getContext("2d");
    ctx.clearRect(0,0,c.width,c.height);
  }

  function canvasToJPEG(canvasId){
    const c = el(canvasId);
    const tmp = document.createElement("canvas");
    tmp.width = c.width; tmp.height = c.height;
    const tctx = tmp.getContext("2d");
    tctx.fillStyle = "#ffffff";
    tctx.fillRect(0,0,tmp.width,tmp.height);
    tctx.drawImage(c,0,0);
    return tmp.toDataURL("image/jpeg", 0.92);
  }

  /********************
   * Imagens
   ********************/
  function fileToDataURL(file){
    return new Promise((resolve, reject)=>{
      if(!file) return resolve(null);
      const r = new FileReader();
      r.onload = ()=> resolve(r.result);
      r.onerror = reject;
      r.readAsDataURL(file);
    });
  }
  async function filesToDataURLs(list){
    const files = Array.from(list || []);
    const out = [];
    for(const f of files){
      const u = await fileToDataURL(f);
      if(u) out.push(u);
    }
    return out;
  }

  async function sha256Hex(str){
    const enc = new TextEncoder().encode(str);
    const buf = await crypto.subtle.digest("SHA-256", enc);
    const arr = Array.from(new Uint8Array(buf));
    return arr.map(b=>b.toString(16).padStart(2,"0")).join("");
  }

  /********************
   * PDF Premium (capa azul + QR + assinaturas + anexos)
   ********************/
  async function gerarPDFPremium(){
    if(!currentId){ currentId = nextPRV(); currentVersion = 1; atualizarBadges(); }
    atualizarResumo();

    const d = getFormData();
    const payloadBase = JSON.stringify({ id: currentId, v: currentVersion, modo: d.modo, ts: Date.now() });
    const hash = await sha256Hex(payloadBase);
    const qrPayload = `PREVIA|${currentId}|v${currentVersion}|${hash.slice(0,24)}`;
    const qrDataUrl = await QRCode.toDataURL(qrPayload, { margin: 1, width: 220 });

    const fotoCapa = await fileToDataURL(el("fotoCapa").files[0]);
    const fotoVia  = await fileToDataURL(el("fotoVia").files[0]);
    const exames   = await filesToDataURLs(el("exames").files);

    const sigP = canvasToJPEG("sigPaciente");
    const sigM = canvasToJPEG("sigMedico");

    const { jsPDF } = window.jspdf;
    const pdf = new jsPDF({unit:"mm", format:"a4"});
    const A4W=210, A4H=297;

    function addHeaderBlue(tag){
      pdf.setFillColor(8,35,58);
      pdf.rect(0,0,A4W,44,"F");
      pdf.setTextColor(255,255,255);
      pdf.setFont("helvetica","bold");
      pdf.setFontSize(24);
      pdf.text("Prévia", 16, 24);

      pdf.setFont("helvetica","normal");
      pdf.setFontSize(12);
      pdf.setTextColor(220,235,255);
      pdf.text("plataforma de avaliação pré-anestésica", 16, 33);

      pdf.setDrawColor(255,255,255);
      pdf.setLineWidth(0.2);
      pdf.roundedRect(142, 12, 52, 18, 5, 5, "S");
      pdf.setFont("helvetica","bold");
      pdf.setFontSize(10);
      pdf.setTextColor(255,255,255);
      pdf.text(tag, 151, 23);
      pdf.setFont("helvetica","normal");
      pdf.setFontSize(9);
      pdf.setTextColor(220,235,255);
      pdf.text(currentId, 147, 30);
    }

    function sectionTitle(y, txt){
      pdf.setTextColor(10,32,51);
      pdf.setFont("helvetica","bold");
      pdf.setFontSize(13);
      pdf.text(txt, 16, y);
      pdf.setDrawColor(200);
      pdf.setLineWidth(0.2);
      pdf.line(16, y+2, 194, y+2);
      return y + 8;
    }

    // PAGE 1 - CAPA
    addHeaderBlue(d.modo==="estetica" ? "Estética" : "Hospital");
    pdf.setTextColor(10,32,51);

    if(d.logoModo==="word"){
      pdf.setFont("helvetica","bold");
      pdf.setFontSize(34);
      pdf.text("Prévia", 16, 92);
    }else if(d.logoModo==="icon"){
      pdf.setFillColor(22,75,140);
      pdf.circle(40, 88, 22, "F");
      pdf.setTextColor(255,255,255);
      pdf.setFont("helvetica","bold");
      pdf.setFontSize(34);
      pdf.text("P", 34.2, 99);
      pdf.setTextColor(10,32,51);
    }

    pdf.setFont("helvetica","normal");
    pdf.setFontSize(12);
    const topY=110;
    pdf.text(`Paciente: ${d.nome || "—"}`, 16, topY);
    pdf.text(`Procedimento: ${d.proced || "—"}`, 16, topY+8);
    pdf.text(`ASA: ${d.asa || "—"}   Mallampati: ${d.mall || "—"}`, 16, topY+16);

    // identidade
    pdf.setFillColor(22,75,140);
    pdf.roundedRect(16, 145, 178, 44, 6, 6, "F");
    pdf.setTextColor(255,255,255);
    pdf.setFont("helvetica","bold");
    pdf.setFontSize(13);
    pdf.text("RT: Dr. Leonardo Alves Araújo", 24, 162);
    pdf.setFont("helvetica","normal");
    pdf.setFontSize(12);
    pdf.text("CRM-MG 47310 • RQE 40542", 24, 172);

    // QR
    pdf.setTextColor(10,32,51);
    pdf.setFontSize(10);
    pdf.text("Verificação:", 152, 206);
    pdf.addImage(qrDataUrl, "PNG", 150, 210, 44, 44);
    pdf.setFontSize(8);
    pdf.setTextColor(70,90,110);
    pdf.text(`ID: ${currentId} • v${currentVersion} • hash: ${hash.slice(0,16)}…`, 16, 272);

    // foto capa
    if(fotoCapa){
      try{
        pdf.addImage(fotoCapa, "JPEG", 132, 60, 62, 62, undefined, "FAST");
        pdf.setDrawColor(255,255,255);
        pdf.setLineWidth(0.2);
        pdf.roundedRect(132, 60, 62, 62, 4, 4, "S");
      }catch(e){}
    }

    // PAGE 2 - RESUMO
    pdf.addPage();
    addHeaderBlue("Resumo");
    let y=56;
    y = sectionTitle(y, "Resumo rápido");
    pdf.setFont("helvetica","normal");
    pdf.setFontSize(11);
    pdf.setTextColor(30,50,70);
    const resumo = el("resumoBox").textContent || "";
    const resumoLines = pdf.splitTextToSize(resumo, 178);
    pdf.text(resumoLines, 16, y);

    // PAGE 3 - CONSENT
    pdf.addPage();
    addHeaderBlue("Consentimento");
    y=56;
    y=sectionTitle(y, "Termo de consentimento informado (resumido)");
    pdf.setFont("helvetica","normal");
    pdf.setFontSize(11);
    pdf.setTextColor(30,50,70);
    const consentTxt = d.consent || consentBase(d.modo==="estetica" ? "estetica":"hospital");
    const consentLines = pdf.splitTextToSize(consentTxt, 178);
    pdf.text(consentLines, 16, y);

    // assinaturas na mesma página (embaixo)
    y = 220;
    pdf.setTextColor(10,32,51);
    pdf.setFont("helvetica","bold");
    pdf.setFontSize(11);
    pdf.text("Assinaturas", 16, y);

    pdf.setDrawColor(180);
    pdf.setLineWidth(0.3);
    pdf.roundedRect(16, y+6, 86, 34, 4, 4, "S");
    pdf.roundedRect(108, y+6, 86, 34, 4, 4, "S");
    pdf.setFont("helvetica","normal");
    pdf.setFontSize(10);
    pdf.setTextColor(70,90,110);
    pdf.text("Paciente", 18, y+14);
    pdf.text("Médico", 110, y+14);

    try{
      pdf.addImage(sigP, "JPEG", 18, y+16, 82, 22, undefined, "FAST");
      pdf.addImage(sigM, "JPEG", 110, y+16, 82, 22, undefined, "FAST");
    }catch(e){}

    // PAGE 4 - ANEXOS (se tiver)
    if(fotoVia || (exames && exames.length)){
      pdf.addPage();
      addHeaderBlue("Anexos");
      y=56;
      y=sectionTitle(y, "Anexos");

      if(fotoVia){
        pdf.setFont("helvetica","bold");
        pdf.setFontSize(12);
        pdf.setTextColor(10,32,51);
        pdf.text("Via aérea", 16, y);
        y+=6;
        try{ pdf.addImage(fotoVia, "JPEG", 16, y, 70, 70, undefined, "FAST"); }catch(e){}
        y+=78;
      }

      if(exames && exames.length){
        pdf.setFont("helvetica","bold");
        pdf.setFontSize(12);
        pdf.setTextColor(10,32,51);
        pdf.text("Exames", 16, y);
        y+=6;

        const cellW=56, cellH=56, x0=16;
        let col=0, row=0;
        for(let i=0;i<exames.length;i++){
          const x = x0 + col*(cellW+4);
          const yy = y + row*(cellH+6);

          if(yy + cellH > 286){
            pdf.addPage();
            addHeaderBlue("Anexos");
            y=56; y=sectionTitle(y, "Exames (continuação)");
            col=0; row=0;
          }

          try{
            pdf.setDrawColor(200);
            pdf.roundedRect(x, yy, cellW, cellH, 3, 3, "S");
            pdf.addImage(exames[i], "JPEG", x+1, yy+1, cellW-2, cellH-2, undefined, "FAST");
          }catch(e){}

          col++; if(col>=3){ col=0; row++; }
        }
      }
    }

    const nomeArquivo = `${currentId}_v${currentVersion}_${(d.nome||"Paciente").replace(/\s+/g,"_")}.pdf`;
    pdf.save(nomeArquivo);
    toast("PDF Premium gerado.");
  }

  /********************
   * Toast
   ********************/
  function toast(msg){
    const t = document.createElement("div");
    t.textContent = msg;
    t.style.position="fixed";
    t.style.left="50%";
    t.style.bottom="86px";
    t.style.transform="translateX(-50%)";
    t.style.background="rgba(0,0,0,.72)";
    t.style.color="#fff";
    t.style.padding="10px 12px";
    t.style.borderRadius="12px";
    t.style.border="1px solid rgba(255,255,255,.18)";
    t.style.zIndex="999";
    t.style.fontSize="14px";
    t.style.backdropFilter="blur(8px)";
    document.body.appendChild(t);
    setTimeout(()=> t.remove(), 1600);
  }

  /********************
   * Init
   ********************/
  function init(){
    // cria um PRV inicial se não existir
    currentId = nextPRV();
    currentVersion = 1;

    // consent default
    el("consent").value = consentBase("hospital");

    setupSignature("sigPaciente");
    setupSignature("sigMedico");

    el("modo").addEventListener("change", ()=>{
      atualizarBadges();
      // se o consent estiver vazio, põe um padrão
      if(!safe(el("consent").value)){
        el("consent").value = consentBase(el("modo").value==="estetica" ? "estetica" : "hospital");
      }
    });

    atualizarBadges();
    renderHistorico();
    renderStep();
    atualizarResumo();
    toast("PRV-26 integrado.");
  }

  init();
</script>
</body>
</html>