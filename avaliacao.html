<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Pr√©via ‚Ä¢ Avalia√ß√£o</title>
  <meta name="color-scheme" content="dark light" />
  <style>
    :root{
      --bg:#0b0f14;
      --card:#0f1621;
      --card2:#0c121b;
      --text:#e8eef7;
      --muted:#9fb0c6;
      --line:rgba(255,255,255,.10);
      --accent:#6aa9ff;
      --ok:#56d364;
      --warn:#ffb020;
      --bad:#ff5d5d;
      --shadow: 0 18px 50px rgba(0,0,0,.45);
      --radius: 18px;
      --radius2: 14px;
      --pad: 18px;
      --w: 980px;
      --font: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family:var(--font);
      color:var(--text);
      background:
        radial-gradient(900px 420px at 12% -10%, rgba(106,169,255,.25), transparent 55%),
        radial-gradient(800px 380px at 90% 10%, rgba(86,211,100,.12), transparent 60%),
        radial-gradient(650px 340px at 75% 90%, rgba(255,176,32,.12), transparent 55%),
        var(--bg);
    }
    a{color:inherit}
    .wrap{max-width:var(--w); margin:0 auto; padding:22px 16px 34px}
    header{
      display:flex; align-items:center; justify-content:space-between; gap:14px;
      padding:14px 14px 10px;
    }
    .brand{
      display:flex; align-items:center; gap:10px;
      user-select:none;
    }
    .logo{
      width:36px;height:36px;border-radius:12px;
      background: linear-gradient(135deg, rgba(106,169,255,.95), rgba(106,169,255,.25));
      box-shadow: 0 10px 20px rgba(106,169,255,.18);
      position:relative;
    }
    .logo:after{
      content:"";
      position:absolute; inset:9px;
      border-radius:10px;
      background:rgba(11,15,20,.45);
      border:1px solid rgba(255,255,255,.14);
    }
    .brand h1{margin:0; font-size:15px; letter-spacing:.2px}
    .brand .sub{font-size:12px; color:var(--muted)}
    .topActions{display:flex; gap:10px; flex-wrap:wrap; justify-content:flex-end}
    .btn{
      border:1px solid var(--line);
      background:rgba(255,255,255,.04);
      color:var(--text);
      border-radius:14px;
      padding:10px 12px;
      font-weight:600;
      cursor:pointer;
      display:inline-flex; align-items:center; gap:8px;
      transition: transform .06s ease, background .2s ease, border-color .2s ease;
    }
    .btn:hover{background:rgba(255,255,255,.06); border-color:rgba(255,255,255,.18)}
    .btn:active{transform: translateY(1px)}
    .btn.primary{
      background: linear-gradient(135deg, rgba(106,169,255,.95), rgba(106,169,255,.35));
      border-color: rgba(106,169,255,.75);
      color:#04101f;
    }
    .btn.primary:hover{filter:brightness(1.02)}
    .btn.danger{border-color: rgba(255,93,93,.5)}
    .btn.ghost{background:transparent}
    .pill{
      display:inline-flex; align-items:center; gap:8px;
      border:1px solid var(--line);
      background: rgba(255,255,255,.03);
      border-radius:999px;
      padding:8px 10px;
      font-size:12px;
      color:var(--muted);
      white-space:nowrap;
    }
    .pill b{color:var(--text); font-weight:700}
    .grid{
      display:grid;
      grid-template-columns: 1.1fr .9fr;
      gap:14px;
    }
    @media (max-width: 860px){
      .grid{grid-template-columns:1fr}
      header{padding-left:0; padding-right:0}
    }
    .card{
      background: linear-gradient(180deg, rgba(255,255,255,.05), rgba(255,255,255,.02));
      border:1px solid var(--line);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
    }
    .card .inner{padding: var(--pad)}
    .titleRow{
      display:flex; align-items:flex-start; justify-content:space-between; gap:14px;
      padding: 16px 18px 0;
    }
    .titleRow h2{margin:0; font-size:16px}
    .titleRow p{margin:6px 0 0; color:var(--muted); font-size:12px; line-height:1.35}
    .progressWrap{
      padding: 14px 18px 12px;
    }
    .bar{
      width:100%;
      height:10px;
      border-radius:999px;
      background: rgba(255,255,255,.06);
      border:1px solid rgba(255,255,255,.10);
      overflow:hidden;
    }
    .bar > i{
      display:block;
      height:100%;
      width:0%;
      background: linear-gradient(90deg, rgba(106,169,255,.95), rgba(86,211,100,.75));
      border-radius:999px;
      transition: width .25s ease;
    }
    .steps{
      margin-top:10px;
      display:flex; flex-wrap:wrap; gap:8px;
    }
    .stepTag{
      font-size:12px;
      padding:7px 10px;
      border-radius:999px;
      border:1px solid var(--line);
      background: rgba(255,255,255,.03);
      color: var(--muted);
    }
    .stepTag.on{color: var(--text); border-color: rgba(106,169,255,.55); background: rgba(106,169,255,.12)}
    .stepTag.done{color: rgba(232,238,247,.95); border-color: rgba(86,211,100,.45); background: rgba(86,211,100,.10)}
    form{padding: 0 18px 16px}
    .pane{display:none}
    .pane.on{display:block}
    .fieldset{
      padding: 14px;
      border-radius: var(--radius2);
      border:1px solid var(--line);
      background: rgba(0,0,0,.14);
      margin-bottom: 12px;
    }
    .fieldset h3{
      margin:0 0 8px;
      font-size:13px;
      letter-spacing:.2px;
    }
    .row{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:10px;
    }
    @media (max-width: 560px){
      .row{grid-template-columns:1fr}
    }
    label{display:block; font-size:12px; color:var(--muted); margin: 8px 0 6px}
    input, select, textarea{
      width:100%;
      padding: 12px 12px;
      border-radius: 12px;
      border:1px solid rgba(255,255,255,.14);
      background: rgba(255,255,255,.04);
      color: var(--text);
      outline:none;
    }
    textarea{min-height:92px; resize:vertical}
    input::placeholder, textarea::placeholder{color: rgba(159,176,198,.65)}
    .checks{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:8px 12px;
      margin-top:8px;
    }
    @media (max-width: 560px){ .checks{grid-template-columns:1fr} }
    .check{
      display:flex; align-items:center; gap:10px;
      padding: 10px 10px;
      border:1px solid rgba(255,255,255,.10);
      border-radius: 12px;
      background: rgba(255,255,255,.03);
    }
    .check input{width:18px; height:18px}
    .footerNav{
      display:flex; align-items:center; justify-content:space-between; gap:10px;
      padding: 0 18px 18px;
      flex-wrap:wrap;
    }
    .hint{font-size:12px; color:var(--muted)}
    .side .inner{padding: 16px}
    .side h3{margin:0 0 10px; font-size:13px}
    .side .box{
      border:1px solid var(--line);
      background: rgba(255,255,255,.03);
      border-radius: 16px;
      padding: 14px;
      margin-bottom: 12px;
    }
    .kv{display:flex; justify-content:space-between; gap:10px; font-size:13px; padding:6px 0; border-bottom:1px dashed rgba(255,255,255,.10)}
    .kv:last-child{border-bottom:none}
    .kv span{color:var(--muted)}
    .asa{
      display:flex; align-items:center; justify-content:space-between; gap:10px;
      padding: 10px 12px;
      border-radius: 14px;
      border:1px solid var(--line);
      background: rgba(255,255,255,.03);
      font-size:13px;
    }
    .asa b{font-size:14px}
    .asa .badge{
      padding:6px 10px; border-radius:999px; font-weight:800; font-size:12px;
      border:1px solid rgba(255,255,255,.14);
    }
    .badge.ok{background: rgba(86,211,100,.10); border-color: rgba(86,211,100,.35); color: rgba(86,211,100,.95)}
    .badge.warn{background: rgba(255,176,32,.10); border-color: rgba(255,176,32,.35); color: rgba(255,176,32,.95)}
    .badge.bad{background: rgba(255,93,93,.10); border-color: rgba(255,93,93,.35); color: rgba(255,93,93,.95)}
    .small{font-size:11px; color:var(--muted); line-height:1.35}
    .mono{font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace}
    .sep{height:1px; background:rgba(255,255,255,.10); margin: 10px 0}
    .toast{
      position: fixed;
      bottom: 14px;
      left: 50%;
      transform: translateX(-50%);
      background: rgba(15,22,33,.92);
      border:1px solid rgba(255,255,255,.14);
      border-radius: 999px;
      padding: 10px 12px;
      font-size: 12px;
      color: var(--text);
      display:none;
      box-shadow: 0 18px 50px rgba(0,0,0,.55);
      backdrop-filter: blur(10px);
      z-index:999;
    }

    /* Print = ‚ÄúPDF‚Äù */
    @media print{
      body{background:#fff;color:#111}
      .btn,.topActions,.toast{display:none !important}
      .card{box-shadow:none;border:1px solid #ddd;background:#fff}
      .brand .sub, .hint, .small{color:#333}
      input,select,textarea{border:1px solid #bbb; color:#111; background:#fff}
      .bar, .steps, .footerNav{display:none !important}
      .grid{grid-template-columns:1fr}
      .wrap{max-width: 900px}
    }
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <div class="brand">
        <div class="logo" aria-hidden="true"></div>
        <div>
          <h1>Pr√©via ‚Ä¢ Avalia√ß√£o</h1>
          <div class="sub">v1 (prot√≥tipo cl√≠nico) ‚Ä¢ salva automaticamente</div>
        </div>
      </div>

      <div class="topActions">
        <span class="pill">Paciente: <b id="pillPaciente">‚Äî</b></span>
        <button class="btn" type="button" id="btnSalvar">Salvar agora</button>
        <button class="btn ghost" type="button" id="btnPDF">Gerar PDF</button>
        <button class="btn danger" type="button" id="btnLimpar">Limpar</button>
      </div>
    </header>

    <div class="grid">
      <section class="card">
        <div class="titleRow">
          <div>
            <h2 id="stepTitle">Dados do paciente</h2>
            <p id="stepDesc">Preencha o essencial. O resto a gente lapida depois ‚Äî o importante √© rodar.</p>
          </div>
          <span class="pill">ID: <b class="mono" id="pillID">PV-‚Äî</b></span>
        </div>

        <div class="progressWrap">
          <div class="bar"><i id="barFill"></i></div>
          <div class="steps" id="stepTags"></div>
        </div>

        <form id="form">
          <!-- STEP 1 -->
          <div class="pane on" data-step="0">
            <div class="fieldset">
              <h3>Identifica√ß√£o</h3>
              <div class="row">
                <div>
                  <label>Nome completo</label>
                  <input name="nome" placeholder="Ex.: Maria Aparecida Silva" autocomplete="name" />
                </div>
                <div>
                  <label>Data de nascimento</label>
                  <input name="nascimento" type="date" />
                </div>
              </div>
              <div class="row">
                <div>
                  <label>Telefone</label>
                  <input name="telefone" placeholder="(31) 9xxxx-xxxx" inputmode="tel" />
                </div>
                <div>
                  <label>E-mail</label>
                  <input name="email" placeholder="exemplo@email.com" inputmode="email" autocomplete="email" />
                </div>
              </div>
            </div>

            <div class="fieldset">
              <h3>Medidas (se souber)</h3>
              <div class="row">
                <div>
                  <label>Peso (kg)</label>
                  <input name="peso" type="number" step="0.1" placeholder="Ex.: 72" />
                </div>
                <div>
                  <label>Altura (cm)</label>
                  <input name="altura" type="number" step="1" placeholder="Ex.: 168" />
                </div>
              </div>
            </div>

            <div class="fieldset">
              <h3>H√°bitos</h3>
              <div class="checks">
                <label class="check"><input type="checkbox" name="tabagismo" />Tabagismo atual</label>
                <label class="check"><input type="checkbox" name="etilismo" />Etilismo frequente</label>
                <label class="check"><input type="checkbox" name="drogas" />Uso de drogas/medica√ß√µes n√£o prescritas</label>
                <label class="check"><input type="checkbox" name="gestante" />Gestante (se aplic√°vel)</label>
              </div>
            </div>
          </div>

          <!-- STEP 2 -->
          <div class="pane" data-step="1">
            <div class="fieldset">
              <h3>Cirurgia / Procedimento</h3>
              <div class="row">
                <div>
                  <label>Procedimento</label>
                  <input name="procedimento" placeholder="Ex.: Rinoplastia, lipo, videolaparoscopia..." />
                </div>
                <div>
                  <label>Data prevista</label>
                  <input name="dataCirurgia" type="date" />
                </div>
              </div>
              <div class="row">
                <div>
                  <label>Tipo</label>
                  <select name="tipoCirurgia">
                    <option value="">Selecione</option>
                    <option>Ambulatorial</option>
                    <option>Interna√ß√£o</option>
                    <option>Urg√™ncia</option>
                  </select>
                </div>
                <div>
                  <label>Jejum previsto (horas)</label>
                  <input name="jejum" type="number" step="1" placeholder="Ex.: 8" />
                </div>
              </div>
            </div>

            <div class="fieldset">
              <h3>Anestesia / eventos pr√©vios</h3>
              <div class="checks">
                <label class="check"><input type="checkbox" name="anestPrev" />J√° fez anestesia antes</label>
                <label class="check"><input type="checkbox" name="pov" />N√°useas/v√¥mitos p√≥s-op pr√©vios</label>
                <label class="check"><input type="checkbox" name="dificil" />Relato de intuba√ß√£o dif√≠cil</label>
                <label class="check"><input type="checkbox" name="alergiaAnest" />Rea√ß√£o/alergia em anestesia pr√©via</label>
              </div>
              <label>Detalhes (se houver)</label>
              <textarea name="detalhesAnest" placeholder="Ex.: n√°useas importantes, broncoespasmo, alergia suspeita, dificuldade de via a√©rea..."></textarea>
            </div>
          </div>

          <!-- STEP 3 -->
          <div class="pane" data-step="2">
            <div class="fieldset">
              <h3>Comorbidades</h3>
              <div class="checks">
                <label class="check"><input type="checkbox" name="hipertensao" />Hipertens√£o</label>
                <label class="check"><input type="checkbox" name="diabetes" />Diabetes</label>
                <label class="check"><input type="checkbox" name="asma" />Asma/DPOC</label>
                <label class="check"><input type="checkbox" name="apneia" />Apneia do sono (diagn√≥stico/suspeita)</label>
                <label class="check"><input type="checkbox" name="cardiopatia" />Cardiopatia</label>
                <label class="check"><input type="checkbox" name="renal" />Doen√ßa renal</label>
                <label class="check"><input type="checkbox" name="hepatica" />Doen√ßa hep√°tica</label>
                <label class="check"><input type="checkbox" name="tireoide" />Dist√∫rbio de tireoide</label>
                <label class="check"><input type="checkbox" name="trombose" />TEV/TVP/EP pr√©via</label>
                <label class="check"><input type="checkbox" name="avc" />AVC/AIT pr√©vio</label>
                <label class="check"><input type="checkbox" name="coronaria" />Angina/infarto pr√©vio</label>
                <label class="check"><input type="checkbox" name="insufCard" />Insufici√™ncia card√≠aca</label>
              </div>
              <label>Observa√ß√µes</label>
              <textarea name="obsComorb" placeholder="Controle, medica√ß√µes, crises recentes, interna√ß√µes, etc."></textarea>
            </div>
          </div>

          <!-- STEP 4 -->
          <div class="pane" data-step="3">
            <div class="fieldset">
              <h3>Medica√ß√µes em uso</h3>
              <label>Liste medica√ß√µes (nome + dose + hor√°rio)</label>
              <textarea name="meds" placeholder="Ex.: Losartana 50mg 1x/dia; Metformina 850mg 2x/dia..."></textarea>
            </div>

            <div class="fieldset">
              <h3>Alergias</h3>
              <div class="checks">
                <label class="check"><input type="checkbox" name="alergiaNenhuma" />Sem alergias conhecidas</label>
                <label class="check"><input type="checkbox" name="alergiaMedic" />Alergia a medicamento</label>
                <label class="check"><input type="checkbox" name="alergiaLatex" />Alergia a l√°tex</label>
                <label class="check"><input type="checkbox" name="alergiaAlimento" />Alergia alimentar</label>
              </div>
              <label>Quais? (se aplic√°vel)</label>
              <textarea name="alergias" placeholder="Ex.: Dipirona (urtic√°ria), Penicilina, l√°tex..."></textarea>
            </div>
          </div>

          <!-- STEP 5 -->
          <div class="pane" data-step="4">
            <div class="fieldset">
              <h3>Capacidade funcional</h3>
              <label>Consegue subir 2 lances de escada sem parar?</label>
              <select name="escada">
                <option value="">Selecione</option>
                <option value="sim">Sim</option>
                <option value="nao">N√£o</option>
                <option value="naosei">N√£o sei / limita√ß√µes</option>
              </select>

              <div class="row">
                <div>
                  <label>Dispneia aos esfor√ßos?</label>
                  <select name="dispneia">
                    <option value="">Selecione</option>
                    <option>N√£o</option>
                    <option>Leve</option>
                    <option>Moderada</option>
                    <option>Importante</option>
                  </select>
                </div>
                <div>
                  <label>Dor tor√°cica?</label>
                  <select name="dorTorax">
                    <option value="">Selecione</option>
                    <option>N√£o</option>
                    <option>Rara</option>
                    <option>Frequentemente</option>
                  </select>
                </div>
              </div>
            </div>

            <div class="fieldset">
              <h3>Exames dispon√≠veis (opcional)</h3>
              <div class="checks">
                <label class="check"><input type="checkbox" name="examesOk" />Exames recentes dispon√≠veis</label>
                <label class="check"><input type="checkbox" name="eco" />Ecocardiograma</label>
                <label class="check"><input type="checkbox" name="ecg" />ECG</label>
                <label class="check"><input type="checkbox" name="rx" />Raio-X / imagem</label>
              </div>
              <label>Observa√ß√µes / datas</label>
              <textarea name="obsExames" placeholder="Ex.: ECG 01/2026 normal; Hb 13,2; creat 0,9..."></textarea>
            </div>
          </div>

          <!-- STEP 6 -->
          <div class="pane" data-step="5">
            <div class="fieldset">
              <h3>Resumo</h3>
              <div class="small">
                Confira os dados abaixo. Ajuste se precisar (voltar) e finalize.
              </div>
              <div class="sep"></div>
              <div id="resumo" class="small"></div>
            </div>

            <div class="fieldset">
              <h3>Observa√ß√µes finais</h3>
              <textarea name="obsFinais" placeholder="Ex.: orienta√ß√µes espec√≠ficas, jejum, suspens√£o/ajuste de medica√ß√µes, riscos discutidos..."></textarea>
            </div>

            <div class="fieldset">
              <h3>Consentimento (prot√≥tipo)</h3>
              <div class="checks">
                <label class="check"><input type="checkbox" name="confirmo" />Confirmo que as informa√ß√µes foram fornecidas pelo paciente/respons√°vel.</label>
              </div>
              <div class="small">
                *Este prot√≥tipo n√£o substitui avalia√ß√£o presencial quando indicada. Use como triagem e apoio ao pr√©-anest√©sico.*
              </div>
            </div>
          </div>
        </form>

        <div class="footerNav">
          <div class="hint" id="navHint">Dica: voc√™ pode fechar a p√°gina. Ela salva sozinha.</div>
          <div style="display:flex; gap:10px; flex-wrap:wrap;">
            <button class="btn" type="button" id="btnVoltar">‚Üê Voltar</button>
            <button class="btn primary" type="button" id="btnAvancar">Avan√ßar ‚Üí</button>
          </div>
        </div>
      </section>

      <aside class="card side">
        <div class="inner">
          <h3>Painel r√°pido</h3>

          <div class="box">
            <div class="kv"><span>Paciente</span><b id="sNome">‚Äî</b></div>
            <div class="kv"><span>Idade</span><b id="sIdade">‚Äî</b></div>
            <div class="kv"><span>IMC</span><b id="sImc">‚Äî</b></div>
            <div class="kv"><span>Procedimento</span><b id="sProc">‚Äî</b></div>
          </div>

          <div class="asa" id="asaBox">
            <div>
              <div style="font-size:12px;color:var(--muted)">ASA sugerido</div>
              <b id="asaTxt">‚Äî</b>
            </div>
            <span class="badge warn" id="asaBadge">avaliar</span>
          </div>

          <div class="box">
            <div style="font-size:12px;color:var(--muted);margin-bottom:8px">Pontos de aten√ß√£o</div>
            <div id="flags" class="small">‚Äî</div>
          </div>

          <div class="small">
            Se algo aqui ficar ‚Äúmuito autom√°tico‚Äù, √≥timo: depois a gente evolui com regras mais finas e anexos.
            O importante agora √© **rodar no mundo real**.
          </div>
        </div>
      </aside>
    </div>
  </div>

  <div class="toast" id="toast">Salvo ‚úÖ</div>

  <script>
    // ====== Config ======
    const STORAGE_KEY = "previa_avaliacao_v1";
    const STEPS = [
      { title:"Dados do paciente", desc:"Preencha o essencial. O resto a gente lapida depois ‚Äî o importante √© rodar." },
      { title:"Procedimento & anestesia pr√©via", desc:"Contexto cir√∫rgico e hist√≥rico anest√©sico. Onde mora o risco (e a paz)." },
      { title:"Comorbidades", desc:"Marque o que existe e anote o que importa: controle, crise, interna√ß√£o, gravidade." },
      { title:"Medica√ß√µes & alergias", desc:"Aqui mora 80% das pegadinhas do perioperat√≥rio. Vamos deixar isso limpo." },
      { title:"Funcionalidade & exames", desc:"Capacidade funcional e exames recentes. O m√≠nimo bem feito j√° muda o jogo." },
      { title:"Resumo", desc:"Checagem final + observa√ß√µes. E pronto: pr√©via objetiva e bonita." }
    ];

    // ====== Helpers ======
    const $ = (q, el=document) => el.querySelector(q);
    const $$ = (q, el=document) => Array.from(el.querySelectorAll(q));
    const toastEl = $("#toast");
    const showToast = (msg="Salvo ‚úÖ") => {
      toastEl.textContent = msg;
      toastEl.style.display = "block";
      clearTimeout(showToast._t);
      showToast._t = setTimeout(()=> toastEl.style.display="none", 1200);
    };

    const form = $("#form");
    const panes = $$(".pane");
    const stepTagsEl = $("#stepTags");
    const barFill = $("#barFill");
    const stepTitle = $("#stepTitle");
    const stepDesc  = $("#stepDesc");
    const navHint   = $("#navHint");

    let step = 0;
    let pvId = "";

    // Build step tags
    STEPS.forEach((s, i)=>{
      const tag = document.createElement("div");
      tag.className = "stepTag" + (i===0 ? " on" : "");
      tag.textContent = `${i+1}. ${s.title}`;
      tag.addEventListener("click", ()=> goTo(i));
      stepTagsEl.appendChild(tag);
    });

    const getData = () => {
      const fd = new FormData(form);
      // checkboxes: include unchecked false
      const data = {};
      for (const [k,v] of fd.entries()) data[k]=v;
      $$("input[type=checkbox]", form).forEach(cb=>{
        data[cb.name] = cb.checked;
      });
      return data;
    };

    const setData = (data) => {
      Object.entries(data||{}).forEach(([k,v])=>{
        const el = form.elements[k];
        if(!el) return;
        if(el.type === "checkbox"){
          el.checked = !!v;
        }else{
          el.value = v ?? "";
        }
      });
    };

    const save = (silent=false) => {
      const data = getData();
      const payload = {
        pvId,
        step,
        updatedAt: new Date().toISOString(),
        data
      };
      localStorage.setItem(STORAGE_KEY, JSON.stringify(payload));
      if(!silent) showToast("Salvo ‚úÖ");
      updateSide();
      if(step === 5) renderResumo();
    };

    const load = () => {
      const raw = localStorage.getItem(STORAGE_KEY);
      if(!raw) {
        pvId = makeId();
        $("#pillID").textContent = pvId;
        save(true);
        return;
      }
      try{
        const payload = JSON.parse(raw);
        pvId = payload.pvId || makeId();
        step = Number.isFinite(payload.step) ? payload.step : 0;
        $("#pillID").textContent = pvId;
        setData(payload.data || {});
        goTo(step, true);
      }catch(e){
        pvId = makeId();
        $("#pillID").textContent = pvId;
      }
      updateSide();
    };

    const makeId = () => {
      const n = Math.floor(10000 + Math.random()*89999);
      return `PV-${n}`;
    };

    const ageFromDOB = (dobStr) => {
      if(!dobStr) return null;
      const d = new Date(dobStr);
      if(isNaN(d.getTime())) return null;
      const now = new Date();
      let age = now.getFullYear() - d.getFullYear();
      const m = now.getMonth() - d.getMonth();
      if(m < 0 || (m === 0 && now.getDate() < d.getDate())) age--;
      return age;
    };

    const calcIMC = (peso, alturaCm) => {
      const p = parseFloat(peso);
      const a = parseFloat(alturaCm);
      if(!p || !a) return null;
      const h = a/100;
      const imc = p/(h*h);
      if(!isFinite(imc)) return null;
      return Math.round(imc*10)/10;
    };

    // ASA heuristic (simples, ajust√°vel)
    const calcASA = (d) => {
      const flags = [];

      const anyMajor =
        d.cardiopatia || d.insufCard || d.coronaria || d.avc || d.renal || d.hepatica;

      const anyMild =
        d.hipertensao || d.diabetes || d.asma || d.apneia || d.tireoide || d.trombose || d.tabagismo;

      const imc = calcIMC(d.peso, d.altura);

      if(d.gestante) flags.push("Gesta√ß√£o: considerar ajustes anest√©sicos e jejum.");
      if(d.dificil)  flags.push("Relato de via a√©rea dif√≠cil: planejar abordagem e backup.");
      if(d.alergiaAnest || d.alergiaMedic || d.alergiaLatex) flags.push("Alergias relevantes: revisar e documentar bem.");
      if(d.pov) flags.push("Hist√≥rico de NVPO: considerar profilaxia multimodal.");
      if(d.apneia) flags.push("Apneia do sono: aten√ß√£o em seda√ß√£o/opioides e p√≥s-op.");
      if(imc && imc >= 35) flags.push("IMC ‚â• 35: risco aumentado (via a√©rea/ventila√ß√£o).");
      if(d.dispneia === "Importante") flags.push("Dispneia importante: considerar avalia√ß√£o adicional.");
      if(d.dorTorax && d.dorTorax !== "N√£o") flags.push("Dor tor√°cica: precisa ser caracterizada.");

      // ASA suggestion:
      let asa = "ASA I";
      let level = "ok";

      if(anyMajor) { asa = "ASA III"; level = "warn"; }
      else if(anyMild) { asa = "ASA II"; level = "ok"; }

      // Escaladores
      if(d.insufCard || d.coronaria || d.avc) { asa = "ASA III"; level = "warn"; }
      if(d.dispneia === "Importante" || d.escada === "nao") { asa = "ASA III"; level = "warn"; }
      if(imc && imc >= 40) { asa = "ASA III"; level = "warn"; }

      // Se nada preenchido, n√£o chutar
      const touched = Object.values(d).some(v => v === true || (typeof v === "string" && v.trim()));
      if(!touched) { asa = "‚Äî"; level = "warn"; }

      return { asa, level, flags: flags.length ? flags : ["‚Äî"] };
    };

    const updateSide = () => {
      const d = getData();
      const nome = (d.nome || "").trim();
      const idade = ageFromDOB(d.nascimento);
      const imc = calcIMC(d.peso, d.altura);
      const proc = (d.procedimento || "").trim();

      $("#sNome").textContent = nome || "‚Äî";
      $("#pillPaciente").textContent = nome ? nome.split(" ")[0] : "‚Äî";
      $("#sIdade").textContent = (idade === null) ? "‚Äî" : `${idade} anos`;
      $("#sImc").textContent = (imc === null) ? "‚Äî" : imc.toFixed(1);
      $("#sProc").textContent = proc || "‚Äî";

      const { asa, level, flags } = calcASA(d);
      $("#asaTxt").textContent = asa;

      const badge = $("#asaBadge");
      badge.className = "badge " + (level==="ok" ? "ok" : level==="bad" ? "bad" : "warn");
      badge.textContent = (asa==="ASA I") ? "baixo risco" :
                          (asa==="ASA II") ? "aten√ß√£o" :
                          (asa==="ASA III") ? "moderado/alto" :
                          "avaliar";

      $("#flags").innerHTML = flags.map(f => `‚Ä¢ ${escapeHtml(f)}`).join("<br>");
    };

    const escapeHtml = (s="") =>
      s.replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;");

    const renderResumo = () => {
      const d = getData();
      const idade = ageFromDOB(d.nascimento);
      const imc = calcIMC(d.peso, d.altura);
      const { asa, flags } = calcASA(d);

      const bits = [];
      const line = (k, v) => bits.push(`<div class="kv"><span>${escapeHtml(k)}</span><b>${escapeHtml(v || "‚Äî")}</b></div>`);

      line("ID", pvId);
      line("Nome", d.nome || "");
      line("Idade", (idade===null) ? "" : `${idade} anos`);
      line("Telefone", d.telefone || "");
      line("E-mail", d.email || "");
      line("Peso/Altura", (d.peso || d.altura) ? `${d.peso||"‚Äî"} kg / ${d.altura||"‚Äî"} cm` : "");
      line("IMC", (imc===null) ? "" : imc.toFixed(1));
      line("Procedimento", d.procedimento || "");
      line("Data", d.dataCirurgia || "");
      line("Tipo", d.tipoCirurgia || "");
      line("Jejum", d.jejum ? `${d.jejum} h` : "");
      line("ASA sugerido", asa);

      const checkList = (title, arr) => {
        bits.push(`<div style="margin-top:10px; font-weight:800">${escapeHtml(title)}</div>`);
        bits.push(`<div class="small">${arr.length ? arr.map(x=>"‚Ä¢ "+escapeHtml(x)).join("<br>") : "‚Äî"}</div>`);
      };

      const comorb = [];
      if(d.hipertensao) comorb.push("Hipertens√£o");
      if(d.diabetes) comorb.push("Diabetes");
      if(d.asma) comorb.push("Asma/DPOC");
      if(d.apneia) comorb.push("Apneia do sono");
      if(d.cardiopatia) comorb.push("Cardiopatia");
      if(d.insufCard) comorb.push("Insufici√™ncia card√≠aca");
      if(d.coronaria) comorb.push("Doen√ßa coronariana");
      if(d.avc) comorb.push("AVC/AIT pr√©vio");
      if(d.renal) comorb.push("Doen√ßa renal");
      if(d.hepatica) comorb.push("Doen√ßa hep√°tica");
      if(d.tireoide) comorb.push("Tireoide");
      if(d.trombose) comorb.push("TEV/TVP/EP pr√©via");
      if(d.tabagismo) comorb.push("Tabagismo atual");

      checkList("Comorbidades/itens marcados", comorb);
      if(d.obsComorb) bits.push(`<div class="small" style="margin-top:6px"><b>Obs:</b> ${escapeHtml(d.obsComorb)}</div>`);

      bits.push(`<div style="margin-top:10px; font-weight:800">Medica√ß√µes</div>`);
      bits.push(`<div class="small">${escapeHtml(d.meds || "‚Äî")}</div>`);

      bits.push(`<div style="margin-top:10px; font-weight:800">Alergias</div>`);
      bits.push(`<div class="small">${escapeHtml(d.alergias || (d.alergiaNenhuma ? "Sem alergias conhecidas" : "‚Äî"))}</div>`);

      bits.push(`<div style="margin-top:10px; font-weight:800">Pontos de aten√ß√£o</div>`);
      bits.push(`<div class="small">${flags.map(f=>"‚Ä¢ "+escapeHtml(f)).join("<br>")}</div>`);

      $("#resumo").innerHTML = bits.join("");
    };

    const goTo = (i, silent=false) => {
      step = Math.max(0, Math.min(STEPS.length-1, i));
      panes.forEach(p=> p.classList.toggle("on", Number(p.dataset.step) === step));
      const tags = $$(".stepTag", stepTagsEl);
      tags.forEach((t, idx)=>{
        t.classList.toggle("on", idx === step);
        t.classList.toggle("done", idx < step);
      });

      stepTitle.textContent = STEPS[step].title;
      stepDesc.textContent  = STEPS[step].desc;
      barFill.style.width = ((step)/(STEPS.length-1))*100 + "%";

      $("#btnVoltar").disabled = (step===0);
      $("#btnAvancar").textContent = (step===STEPS.length-1) ? "Finalizar ‚úî" : "Avan√ßar ‚Üí";

      navHint.textContent = (step===STEPS.length-1)
        ? "Finalize, gere PDF se quiser e pronto. Sem drama."
        : "Dica: voc√™ pode fechar a p√°gina. Ela salva sozinha.";

      if(!silent) save(true);
      updateSide();
      if(step === 5) renderResumo();
      $("#pillID").textContent = pvId;
    };

    // ====== Events ======
    $("#btnVoltar").addEventListener("click", ()=> goTo(step-1));
    $("#btnAvancar").addEventListener("click", ()=>{
      if(step < STEPS.length-1) return goTo(step+1);
      // Finalizar
      const d = getData();
      if(!d.confirmo){
        showToast("Marque a confirma√ß√£o no final üôÇ");
        return;
      }
      save(false);
      showToast("Finalizado ‚úÖ");
      renderResumo();
    });

    $("#btnSalvar").addEventListener("click", ()=> save(false));
    $("#btnPDF").addEventListener("click", ()=>{
      save(true);
      // render resumo antes de imprimir
      goTo(5, true);
      renderResumo();
      window.print();
    });

    $("#btnLimpar").addEventListener("click", ()=>{
      if(!confirm("Limpar tudo desta avalia√ß√£o?")) return;
      localStorage.removeItem(STORAGE_KEY);
      // reset
      form.reset();
      pvId = makeId();
      $("#pillID").textContent = pvId;
      goTo(0, true);
      save(false);
      showToast("Zerado üßº");
    });

    // Auto-save (debounced)
    let t;
    form.addEventListener("input", ()=>{
      clearTimeout(t);
      t = setTimeout(()=> save(true), 250);
    });

    // On load
    load();
  </script>
</body>
</html>
